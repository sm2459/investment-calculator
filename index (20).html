<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Allocation Calculator</title>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3Q3LVYK5PH"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-3Q3LVYK5PH');
    </script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // Lucide React icons as inline SVGs
        const DollarSign = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
        );

        const TrendingUp = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
        );

        const Percent = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="19" y1="5" x2="5" y2="19"></line>
                <circle cx="6.5" cy="6.5" r="2.5"></circle>
                <circle cx="17.5" cy="17.5" r="2.5"></circle>
            </svg>
        );

        const Info = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
        );

        const Sliders = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="4" y1="21" x2="4" y2="14"></line>
                <line x1="4" y1="10" x2="4" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12" y2="3"></line>
                <line x1="20" y1="21" x2="20" y2="16"></line>
                <line x1="20" y1="12" x2="20" y2="3"></line>
                <line x1="1" y1="14" x2="7" y2="14"></line>
                <line x1="9" y1="8" x2="15" y2="8"></line>
                <line x1="17" y1="16" x2="23" y2="16"></line>
            </svg>
        );

        const Sparkles = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path>
                <path d="M5 3v4"></path>
                <path d="M19 17v4"></path>
                <path d="M3 5h4"></path>
                <path d="M17 19h4"></path>
            </svg>
        );

        const Mail = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>
            </svg>
        );

        const Download = ({ className }) => (
            <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        function InvestmentCalculator() {
            const [mode, setMode] = useState('guided'); // 'guided' or 'custom'
            const [investmentAmount, setInvestmentAmount] = useState(10000);
            const [age, setAge] = useState(30); // User's current age
            const [timeHorizon, setTimeHorizon] = useState(10); // Years
            const [usAllocation, setUsAllocation] = useState(70);
            const [bondAllocation, setBondAllocation] = useState(0); // Bonds percentage
            const [recurringContribution, setRecurringContribution] = useState(0);
            const [contributionFrequency, setContributionFrequency] = useState('monthly'); // 'daily', 'weekly', 'monthly', 'quarterly', 'annually'
            const [userEmail, setUserEmail] = useState('');
            const [isGeneratingPDF, setIsGeneratingPDF] = useState(false);
            const [stressTestExpanded, setStressTestExpanded] = useState(false);
            const [stressTestTab, setStressTestTab] = useState('historical'); // 'historical', 'what-if', 'vs-cash'
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const growthChartRef = useRef(null);
            const growthChartInstance = useRef(null);
            
            // Calculate recommended bond allocation based on age (Rule of 110)
            // Rule of 110: 110 - age = % in stocks, remainder in bonds
            // So bonds = 100 - (110 - age) = age - 10
            const recommendedBondAllocation = isNaN(age) || age === '' 
                ? 20 // Default recommendation if age is invalid
                : Math.max(0, Math.min(60, Number(age) - 10));
            
            // Adjust stock allocations to account for bonds
            const stockAllocation = 100 - bondAllocation;
            const internationalAllocation = stockAllocation - usAllocation;
            
            // Auto-calculate expected returns based on portfolio allocation
            // Historical averages: Stocks ~10%, Bonds ~4%
            const stockReturn = 10; // 10% for stocks
            const bondReturn = 4;   // 4% for bonds
            const baseExpectedReturn = ((stockAllocation / 100) * stockReturn) + ((bondAllocation / 100) * bondReturn);
            
            // Create 4 scenarios: Conservative, Expected, Optimistic, Crisis
            const scenarios = {
                conservative: Math.max(3, baseExpectedReturn - 2), // Conservative: -2% from base, minimum 3%
                expected: baseExpectedReturn,                       // Expected: portfolio-based
                optimistic: Math.min(12, baseExpectedReturn + 2),  // Optimistic: +2% from base, maximum 12%
                crisis: 2.5                                         // Crisis: 2.5% (severe downturn, barely beats inflation)
            };
            
            // Inflation rate for real value calculations
            const inflationRate = 0.03; // 3% annual inflation

            // ETF options with real data - expanded with multiple providers
            const etfs = {
                // Vanguard ETFs
                voo: { 
                    name: 'VOO', 
                    fullName: 'Vanguard S&P 500 ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Large Cap',
                    provider: 'Vanguard',
                    dividendYield: 1.5,
                    taxEfficiency: 'Excellent',
                    turnover: 3
                },
                vti: { 
                    name: 'VTI', 
                    fullName: 'Vanguard Total Stock Market ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Total Market',
                    provider: 'Vanguard',
                    dividendYield: 1.5,
                    taxEfficiency: 'Excellent',
                    turnover: 4
                },
                vxus: { 
                    name: 'VXUS', 
                    fullName: 'Vanguard Total International Stock ETF', 
                    expenseRatio: 0.08, 
                    type: 'International',
                    provider: 'Vanguard',
                    dividendYield: 3.2,
                    taxEfficiency: 'Very Good',
                    turnover: 5
                },
                vb: { 
                    name: 'VB', 
                    fullName: 'Vanguard Small-Cap ETF', 
                    expenseRatio: 0.05, 
                    type: 'US Small Cap',
                    provider: 'Vanguard',
                    dividendYield: 1.3,
                    taxEfficiency: 'Very Good',
                    turnover: 15
                },
                vwo: { 
                    name: 'VWO', 
                    fullName: 'Vanguard Emerging Markets ETF', 
                    expenseRatio: 0.08, 
                    type: 'Emerging Markets',
                    provider: 'Vanguard',
                    dividendYield: 3.5,
                    taxEfficiency: 'Good',
                    turnover: 8
                },
                vea: { 
                    name: 'VEA', 
                    fullName: 'Vanguard Developed Markets ETF', 
                    expenseRatio: 0.05, 
                    type: 'Developed International',
                    provider: 'Vanguard',
                    dividendYield: 3.0,
                    taxEfficiency: 'Very Good',
                    turnover: 4
                },
                
                // Schwab ETFs
                schb: { 
                    name: 'SCHB', 
                    fullName: 'Schwab U.S. Broad Market ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Total Market',
                    provider: 'Schwab',
                    dividendYield: 1.4,
                    taxEfficiency: 'Excellent',
                    turnover: 4
                },
                schx: { 
                    name: 'SCHX', 
                    fullName: 'Schwab U.S. Large-Cap ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Large Cap',
                    provider: 'Schwab',
                    dividendYield: 1.5,
                    taxEfficiency: 'Excellent',
                    turnover: 3
                },
                schf: { 
                    name: 'SCHF', 
                    fullName: 'Schwab International Equity ETF', 
                    expenseRatio: 0.06, 
                    type: 'International',
                    provider: 'Schwab',
                    dividendYield: 3.1,
                    taxEfficiency: 'Very Good',
                    turnover: 5
                },
                scha: { 
                    name: 'SCHA', 
                    fullName: 'Schwab U.S. Small-Cap ETF', 
                    expenseRatio: 0.04, 
                    type: 'US Small Cap',
                    provider: 'Schwab',
                    dividendYield: 1.2,
                    taxEfficiency: 'Very Good',
                    turnover: 12
                },
                sche: { 
                    name: 'SCHE', 
                    fullName: 'Schwab Emerging Markets Equity ETF', 
                    expenseRatio: 0.11, 
                    type: 'Emerging Markets',
                    provider: 'Schwab',
                    dividendYield: 3.4,
                    taxEfficiency: 'Good',
                    turnover: 9
                },
                
                // iShares Core ETFs (BlackRock)
                itot: { 
                    name: 'ITOT', 
                    fullName: 'iShares Core S&P Total U.S. Stock Market ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Total Market',
                    provider: 'iShares',
                    dividendYield: 1.4,
                    taxEfficiency: 'Excellent',
                    turnover: 3
                },
                ivv: { 
                    name: 'IVV', 
                    fullName: 'iShares Core S&P 500 ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Large Cap',
                    provider: 'iShares',
                    dividendYield: 1.5,
                    taxEfficiency: 'Excellent',
                    turnover: 3
                },
                ixus: { 
                    name: 'IXUS', 
                    fullName: 'iShares Core MSCI Total International Stock ETF', 
                    expenseRatio: 0.07, 
                    type: 'International',
                    provider: 'iShares',
                    dividendYield: 3.3,
                    taxEfficiency: 'Very Good',
                    turnover: 5
                },
                ijr: { 
                    name: 'IJR', 
                    fullName: 'iShares Core S&P Small-Cap ETF', 
                    expenseRatio: 0.06, 
                    type: 'US Small Cap',
                    provider: 'iShares',
                    dividendYield: 1.3,
                    taxEfficiency: 'Very Good',
                    turnover: 14
                },
                iemg: { 
                    name: 'IEMG', 
                    fullName: 'iShares Core MSCI Emerging Markets ETF', 
                    expenseRatio: 0.09, 
                    type: 'Emerging Markets',
                    provider: 'iShares',
                    dividendYield: 3.6,
                    taxEfficiency: 'Good',
                    turnover: 10
                },
                
                // SPDR (State Street)
                spy: { 
                    name: 'SPY', 
                    fullName: 'SPDR S&P 500 ETF Trust', 
                    expenseRatio: 0.09, 
                    type: 'US Large Cap',
                    provider: 'SPDR',
                    dividendYield: 1.5,
                    taxEfficiency: 'Excellent',
                    turnover: 3
                },
                sptm: { 
                    name: 'SPTM', 
                    fullName: 'SPDR Portfolio S&P 1500 Composite Stock Market ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Total Market',
                    provider: 'SPDR',
                    dividendYield: 1.4,
                    taxEfficiency: 'Excellent',
                    turnover: 4
                },
                spem: { 
                    name: 'SPEM', 
                    fullName: 'SPDR Portfolio Emerging Markets ETF', 
                    expenseRatio: 0.07, 
                    type: 'Emerging Markets',
                    provider: 'SPDR',
                    dividendYield: 3.7,
                    taxEfficiency: 'Good',
                    turnover: 11
                },
                
                // Bond ETFs
                bnd: { 
                    name: 'BND', 
                    fullName: 'Vanguard Total Bond Market ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Bonds',
                    provider: 'Vanguard',
                    dividendYield: 4.2,
                    taxEfficiency: 'Excellent',
                    turnover: 10
                },
                agg: { 
                    name: 'AGG', 
                    fullName: 'iShares Core US Aggregate Bond ETF', 
                    expenseRatio: 0.03, 
                    type: 'US Bonds',
                    provider: 'iShares',
                    dividendYield: 4.1,
                    taxEfficiency: 'Excellent',
                    turnover: 9
                },
                bndw: { 
                    name: 'BNDW', 
                    fullName: 'Vanguard Total World Bond ETF', 
                    expenseRatio: 0.05, 
                    type: 'Global Bonds',
                    provider: 'Vanguard',
                    dividendYield: 4.0,
                    taxEfficiency: 'Very Good',
                    turnover: 11
                }
            };

            // Guided portfolio options
            const guidedPortfolios = [
                { 
                    name: '3-Fund Balanced', 
                    funds: [
                        { ticker: 'VTI', allocation: 'us' },
                        { ticker: 'VXUS', allocation: 'international' },
                        { ticker: 'BND', allocation: 'bonds' }
                    ],
                    description: 'Classic 3-fund with bonds (age-based)',
                    complexity: '3 funds',
                    hasBonds: true
                },
                { 
                    name: '3-Fund Conservative', 
                    funds: [
                        { ticker: 'VOO', allocation: 'us' },
                        { ticker: 'VXUS', allocation: 'international' },
                        { ticker: 'BND', allocation: 'bonds' }
                    ],
                    description: 'S&P 500 with bonds for stability',
                    complexity: '3 funds',
                    hasBonds: true
                },
                { 
                    name: 'Simple Two-Fund', 
                    funds: [
                        { ticker: 'VTI', allocation: 'us' },
                        { ticker: 'VXUS', allocation: 'international' }
                    ],
                    description: 'Classic & clean - total market coverage',
                    complexity: 'Simplest'
                },
                { 
                    name: 'S&P 500 Focus', 
                    funds: [
                        { ticker: 'VOO', allocation: 'us' },
                        { ticker: 'VXUS', allocation: 'international' }
                    ],
                    description: 'Large-cap US companies',
                    complexity: 'Simplest'
                },
                { 
                    name: 'Small-Cap Tilt', 
                    funds: [
                        { ticker: 'VOO', allocation: 'us', weight: 0.8 },
                        { ticker: 'VB', allocation: 'us', weight: 0.2 },
                        { ticker: 'VXUS', allocation: 'international' }
                    ],
                    description: '80/20 large/small cap US split',
                    complexity: '3 funds'
                },
                { 
                    name: 'Emerging Markets Split', 
                    funds: [
                        { ticker: 'VTI', allocation: 'us' },
                        { ticker: 'VEA', allocation: 'international', weight: 0.6 },
                        { ticker: 'VWO', allocation: 'international', weight: 0.4 }
                    ],
                    description: 'Separate developed & emerging intl',
                    complexity: '3 funds'
                }
            ];

            const [selectedPortfolio, setSelectedPortfolio] = useState(0);
            
            // Auto-adjust bond allocation when switching to/from 3-fund portfolios
            useEffect(() => {
                if (mode === 'guided' && guidedPortfolios[selectedPortfolio].hasBonds && bondAllocation === 0) {
                    setBondAllocation(recommendedBondAllocation);
                } else if (mode === 'guided' && !guidedPortfolios[selectedPortfolio].hasBonds) {
                    setBondAllocation(0);
                }
            }, [selectedPortfolio, mode]);
            
            // Custom mode state
            const [customFunds, setCustomFunds] = useState([
                { ticker: 'VTI', allocation: 70 },
                { ticker: 'VXUS', allocation: 30 }
            ]);

            // Calculate allocations based on mode
            const getCurrentFunds = () => {
                if (mode === 'guided') {
                    const portfolio = guidedPortfolios[selectedPortfolio];
                    const usAmount = (investmentAmount * usAllocation) / 100;
                    const intAmount = (investmentAmount * internationalAllocation) / 100;
                    const bondsAmount = (investmentAmount * bondAllocation) / 100;
                    
                    return portfolio.funds.map(fund => {
                        const etf = etfs[fund.ticker.toLowerCase()];
                        let baseAmount;
                        if (fund.allocation === 'us') {
                            baseAmount = usAmount;
                        } else if (fund.allocation === 'international') {
                            baseAmount = intAmount;
                        } else if (fund.allocation === 'bonds') {
                            baseAmount = bondsAmount;
                        }
                        const weight = fund.weight || 1;
                        const amount = baseAmount * weight;
                        const cost = amount * (etf.expenseRatio / 100);
                        
                        return {
                            ...etf,
                            ticker: fund.ticker,
                            amount,
                            cost,
                            percentage: (amount / investmentAmount) * 100
                        };
                    });
                } else {
                    // Custom mode
                    return customFunds.map(fund => {
                        const etf = etfs[fund.ticker.toLowerCase()];
                        const amount = (investmentAmount * fund.allocation) / 100;
                        const cost = amount * (etf.expenseRatio / 100);
                        
                        return {
                            ...etf,
                            ticker: fund.ticker,
                            amount,
                            cost,
                            percentage: fund.allocation
                        };
                    });
                }
            };

            const fundAllocations = getCurrentFunds();

            // Calculate totals
            const totalCost = fundAllocations.reduce((sum, fund) => sum + fund.cost, 0);
            const weightedExpenseRatio = investmentAmount > 0 
                ? fundAllocations.reduce((sum, fund) => sum + (fund.amount * fund.expenseRatio), 0) / investmentAmount
                : fundAllocations.reduce((sum, fund) => sum + fund.expenseRatio, 0) / fundAllocations.length;

            // Calculate growth projections with DCA
            const calculateGrowth = (returnRate) => {
                const years = [];
                const values = [];
                const costImpact = [];
                const totalContributions = [];
                const dividendIncome = [];
                
                // Calculate weighted average dividend yield
                const weightedDividendYield = fundAllocations.reduce((sum, fund) => 
                    sum + ((fund.amount / investmentAmount) * fund.dividendYield), 0) || 
                    fundAllocations.reduce((sum, fund) => sum + fund.dividendYield, 0) / fundAllocations.length;
                
                // Convert contribution frequency to number of periods per year
                const periodsPerYear = contributionFrequency === 'daily' ? 252 :      // Business days (Mon-Fri)
                                     contributionFrequency === 'weekly' ? 52 : 
                                     contributionFrequency === 'monthly' ? 12 : 
                                     contributionFrequency === 'quarterly' ? 4 : 1;
                const contributionPerPeriod = recurringContribution;
                
                for (let year = 0; year <= timeHorizon; year++) {
                    years.push(year);
                    
                    let portfolioValue = investmentAmount;
                    let portfolioValueNoFees = investmentAmount;
                    let totalInvested = investmentAmount;
                    let yearlyDividends = 0;
                    
                    const netReturn = (returnRate - weightedExpenseRatio) / 100;
                    const grossReturn = returnRate / 100;
                    
                    // Calculate compound interest with regular contributions
                    for (let period = 1; period <= year * periodsPerYear; period++) {
                        // Add contribution at the beginning of each period
                        portfolioValue += contributionPerPeriod;
                        portfolioValueNoFees += contributionPerPeriod;
                        totalInvested += contributionPerPeriod;
                        
                        // Apply return for the period (annual rate / periods per year)
                        portfolioValue *= (1 + netReturn / periodsPerYear);
                        portfolioValueNoFees *= (1 + grossReturn / periodsPerYear);
                    }
                    
                    // Calculate dividends for the year (estimate based on average portfolio value)
                    if (year > 0) {
                        const avgPortfolioValue = (values[year - 1] + portfolioValue) / 2;
                        yearlyDividends = avgPortfolioValue * (weightedDividendYield / 100);
                    }
                    
                    // If year 0, just use initial investment
                    if (year === 0) {
                        portfolioValue = investmentAmount;
                        portfolioValueNoFees = investmentAmount;
                        totalInvested = investmentAmount;
                        yearlyDividends = investmentAmount * (weightedDividendYield / 100);
                    }
                    
                    values.push(portfolioValue);
                    costImpact.push(portfolioValueNoFees - portfolioValue);
                    totalContributions.push(totalInvested);
                    dividendIncome.push(yearlyDividends);
                }
                
                return { years, values, costImpact, totalContributions, dividendIncome, weightedDividendYield };
            };

            // Calculate growth for all 4 scenarios
            const growthDataConservative = calculateGrowth(scenarios.conservative);
            const growthDataExpected = calculateGrowth(scenarios.expected);
            const growthDataOptimistic = calculateGrowth(scenarios.optimistic);
            const growthDataCrisis = calculateGrowth(scenarios.crisis);
            
            // Use expected scenario as the main data source (for compatibility)
            const growthData = growthDataExpected;
            const finalValue = growthData.values[growthData.values.length - 1];
            const totalContributed = growthData.totalContributions[growthData.totalContributions.length - 1];
            const totalReturn = finalValue - totalContributed;
            const totalFeesLost = growthData.costImpact[growthData.costImpact.length - 1];
            const totalDividends = growthData.dividendIncome.reduce((sum, val) => sum + val, 0);
            const capitalGains = totalReturn - totalDividends;
            
            // Calculate financial advisor cost (1% annual fee on AUM vs low-cost ETFs)
            const advisorFeeRate = 1.0; // 1% annual fee typical for financial advisors
            const calculateAdvisorCost = () => {
                // Calculate portfolio WITH 1% advisor fee deducted each year
                // Advisor charges 1% of portfolio value annually (taken from assets)
                const grossReturn = scenarios.expected / 100; // Convert to decimal
                const etfExpenseRatio = weightedExpenseRatio / 100;
                
                const periodsPerYear = contributionFrequency === 'daily' ? 252 :
                                     contributionFrequency === 'weekly' ? 52 :
                                     contributionFrequency === 'monthly' ? 12 :
                                     contributionFrequency === 'quarterly' ? 4 : 1;
                
                let portfolioValueAdvisor = investmentAmount;
                
                for (let year = 0; year < timeHorizon; year++) {
                    // Add contributions and grow the portfolio each period
                    for (let period = 1; period <= periodsPerYear; period++) {
                        portfolioValueAdvisor += recurringContribution;
                        // Grow at gross return minus ETF expenses (advisor invests in same ETFs)
                        portfolioValueAdvisor *= (1 + (grossReturn - etfExpenseRatio) / periodsPerYear);
                    }
                    // At end of year, advisor takes their 1% fee from the portfolio value
                    portfolioValueAdvisor *= (1 - (advisorFeeRate / 100));
                }
                
                // Compare to our low-cost ETF portfolio
                const advisorFeeLost = finalValue - portfolioValueAdvisor;
                return advisorFeeLost;
            };
            
            const totalAdvisorFeesLost = calculateAdvisorCost();
            
            // Calculate historical crisis scenarios
            const calculateHistoricalCrisis = (annualReturns) => {
                // annualReturns is an array of returns for each year
                let portfolioValue = investmentAmount;
                let totalInvested = investmentAmount;
                
                const periodsPerYear = contributionFrequency === 'daily' ? 252 :
                                     contributionFrequency === 'weekly' ? 52 :
                                     contributionFrequency === 'monthly' ? 12 :
                                     contributionFrequency === 'quarterly' ? 4 : 1;
                
                for (let year = 0; year < annualReturns.length && year < timeHorizon; year++) {
                    const returnRate = annualReturns[year] / 100;
                    const netReturn = (annualReturns[year] - weightedExpenseRatio) / 100;
                    
                    for (let period = 1; period <= periodsPerYear; period++) {
                        portfolioValue += recurringContribution;
                        totalInvested += recurringContribution;
                        portfolioValue *= (1 + netReturn / periodsPerYear);
                    }
                }
                
                // Fill remaining years with expected return if crisis is shorter than time horizon
                for (let year = annualReturns.length; year < timeHorizon; year++) {
                    const netReturn = (scenarios.expected - weightedExpenseRatio) / 100;
                    for (let period = 1; period <= periodsPerYear; period++) {
                        portfolioValue += recurringContribution;
                        totalInvested += recurringContribution;
                        portfolioValue *= (1 + netReturn / periodsPerYear);
                    }
                }
                
                return { finalValue: portfolioValue, totalInvested };
            };
            
            // Model specific historical crises
            const crisis2008 = calculateHistoricalCrisis([-37, 26, 15, 2, 16, 32, 14, 12, 21, 29]); // 2008-2017 S&P 500 actual
            const crisisDotCom = calculateHistoricalCrisis([-9, -12, -22, 29, 11, 5, 16, 16, -37, 26]); // 2000-2009 actual
            const crisisDepression = calculateHistoricalCrisis([-43, -25, -9, -43, 50, 47, 32, -35, 31, 0]); // 1929-1938 modeled
            
            // Calculate "what-if" scenarios
            const calculateWhatIf = (usImpact, intlImpact, bondImpact) => {
                // Impact is percentage loss (e.g., -60 for 60% loss)
                const usLoss = (usAllocation / 100) * (usImpact / 100) * investmentAmount;
                const intlLoss = (internationalAllocation / 100) * (intlImpact / 100) * investmentAmount;
                const bondLoss = (bondAllocation / 100) * (bondImpact / 100) * investmentAmount;
                const immediateImpact = usLoss + intlLoss + bondLoss;
                
                // Calculate remaining value after crisis, then grow at expected rate
                const startingValue = investmentAmount + immediateImpact; // immediateImpact is negative
                const netReturn = (scenarios.expected - weightedExpenseRatio) / 100;
                
                const periodsPerYear = contributionFrequency === 'daily' ? 252 :
                                     contributionFrequency === 'weekly' ? 52 :
                                     contributionFrequency === 'monthly' ? 12 :
                                     contributionFrequency === 'quarterly' ? 4 : 1;
                
                let portfolioValue = startingValue;
                let totalInvested = investmentAmount;
                
                for (let year = 0; year < timeHorizon; year++) {
                    for (let period = 1; period <= periodsPerYear; period++) {
                        portfolioValue += recurringContribution;
                        totalInvested += recurringContribution;
                        portfolioValue *= (1 + netReturn / periodsPerYear);
                    }
                }
                
                return { 
                    finalValue: portfolioValue, 
                    totalInvested,
                    immediateImpact,
                    impactPercent: (immediateImpact / investmentAmount) * 100
                };
            };
            
            const whatIfSmallCap = calculateWhatIf(-60, 0, 0); // Small-cap wipeout
            const whatIfBondCrisis = calculateWhatIf(0, 0, -20); // Bond crisis (rates spike)
            const whatIfIntlCollapse = calculateWhatIf(0, -100, 0); // International collapse
            const whatIfArmageddon = calculateWhatIf(-60, -100, -20); // All three at once
            
            // Calculate cash/inflation comparison
            const cashScenario = calculateGrowth(0); // 0% return
            const inflationLoss = calculateGrowth(-3); // -3% real return (losing to inflation)

            // Find lowest fee portfolio for comparison
            const getLowestFeePortfolio = () => {
                let lowestFee = Infinity;
                let lowestIndex = 0;
                
                guidedPortfolios.forEach((portfolio, index) => {
                    const usAmount = (investmentAmount * usAllocation) / 100;
                    const intAmount = (investmentAmount * internationalAllocation) / 100;
                    
                    const fee = portfolio.funds.reduce((sum, fund) => {
                        const etf = etfs[fund.ticker.toLowerCase()];
                        const baseAmount = fund.allocation === 'us' ? usAmount : intAmount;
                        const weight = fund.weight || 1;
                        const amount = baseAmount * weight;
                        return sum + (amount * etf.expenseRatio);
                    }, 0) / investmentAmount;
                    
                    if (fee < lowestFee) {
                        lowestFee = fee;
                        lowestIndex = index;
                    }
                });
                
                return { lowestFee, lowestIndex };
            };

            const { lowestFee, lowestIndex } = mode === 'guided' ? getLowestFeePortfolio() : { lowestFee: null, lowestIndex: null };

            // Data for pie chart
            const colors = ['#3b82f6', '#6366f1', '#10b981', '#059669', '#f59e0b', '#ef4444'];

            // Create/update allocation chart
            useEffect(() => {
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    // Only create chart if there's money to show
                    if (investmentAmount > 0) {
                        chartInstance.current = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: fundAllocations.map(fund => fund.ticker),
                                datasets: [{
                                    data: fundAllocations.map(fund => fund.amount),
                                    backgroundColor: colors.slice(0, fundAllocations.length),
                                    borderWidth: 2,
                                    borderColor: '#ffffff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            padding: 15,
                                            font: { size: 12 }
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.parsed || 0;
                                                return label + ': $' + value.toLocaleString('en-US', { 
                                                    minimumFractionDigits: 2, 
                                                    maximumFractionDigits: 2 
                                                });
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                }

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [fundAllocations, investmentAmount]);

            // Create/update growth chart
            useEffect(() => {
                if (growthChartRef.current) {
                    const ctx = growthChartRef.current.getContext('2d');
                    
                    if (growthChartInstance.current) {
                        growthChartInstance.current.destroy();
                    }

                    growthChartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: growthData.years,
                            datasets: [
                                {
                                    label: '🚀 Optimistic (' + scenarios.optimistic.toFixed(1) + '%)',
                                    data: growthDataOptimistic.values,
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.05)',
                                    fill: false,
                                    tension: 0.4,
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                },
                                {
                                    label: '🎯 Expected (' + scenarios.expected.toFixed(1) + '%)',
                                    data: growthDataExpected.values,
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    borderWidth: 3
                                },
                                {
                                    label: '🐢 Conservative (' + scenarios.conservative.toFixed(1) + '%)',
                                    data: growthDataConservative.values,
                                    borderColor: '#f97316',
                                    backgroundColor: 'rgba(249, 115, 22, 0.05)',
                                    fill: false,
                                    tension: 0.4,
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                },
                                {
                                    label: '💥 Market Crisis (' + scenarios.crisis.toFixed(1) + '%)',
                                    data: growthDataCrisis.values,
                                    borderColor: '#dc2626',
                                    backgroundColor: 'rgba(220, 38, 38, 0.05)',
                                    fill: false,
                                    tension: 0.4,
                                    borderWidth: 2,
                                    borderDash: [10, 5]
                                },
                                {
                                    label: 'Total Contributions',
                                    data: growthData.totalContributions,
                                    borderColor: '#6b7280',
                                    backgroundColor: 'rgba(107, 114, 128, 0.05)',
                                    fill: false,
                                    tension: 0.4,
                                    borderDash: [2, 2],
                                    borderWidth: 1.5
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString('en-US', { 
                                                minimumFractionDigits: 0, 
                                                maximumFractionDigits: 0 
                                            });
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: function(value) {
                                            if (value >= 1000000) {
                                                return '$' + (value / 1000000).toFixed(1) + 'M';
                                            } else if (value >= 1000) {
                                                return '$' + (value / 1000).toFixed(0) + 'k';
                                            } else {
                                                return '$' + value.toFixed(0);
                                            }
                                        }
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Years'
                                    }
                                }
                            }
                        }
                    });
                }

                return () => {
                    if (growthChartInstance.current) {
                        growthChartInstance.current.destroy();
                    }
                };
            }, [growthData, scenarios.conservative, scenarios.expected, scenarios.optimistic, timeHorizon, recurringContribution, contributionFrequency, fundAllocations]);

            const addCustomFund = () => {
                const availableFunds = Object.keys(etfs).filter(
                    key => !customFunds.some(f => f.ticker.toLowerCase() === key)
                );
                if (availableFunds.length > 0) {
                    setCustomFunds([...customFunds, { 
                        ticker: availableFunds[0].toUpperCase(), 
                        allocation: 0 
                    }]);
                }
            };

            const removeCustomFund = (index) => {
                if (customFunds.length > 1) {
                    setCustomFunds(customFunds.filter((_, i) => i !== index));
                }
            };

            const updateCustomFund = (index, field, value) => {
                const updated = [...customFunds];
                updated[index][field] = value;
                setCustomFunds(updated);
            };

            const normalizeAllocations = () => {
                const numFunds = customFunds.length;
                const baseAllocation = Math.floor(100 / numFunds);
                const remainder = 100 - (baseAllocation * numFunds);
                
                // Distribute evenly, giving remainder to first fund(s)
                const normalized = customFunds.map((fund, index) => ({
                    ...fund,
                    allocation: baseAllocation + (index < remainder ? 1 : 0)
                }));
                
                setCustomFunds(normalized);
            };

            const generatePDF = async () => {
                setIsGeneratingPDF(true);
                
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = 210;
                    const pageHeight = 297;
                    const margin = 20;
                    let yPos = 0;
                    
                    // Helper function to add colored box
                    const addColoredBox = (x, y, width, height, fillColor, borderColor) => {
                        pdf.setFillColor(fillColor[0], fillColor[1], fillColor[2]);
                        pdf.setDrawColor(borderColor[0], borderColor[1], borderColor[2]);
                        pdf.setLineWidth(0.5);
                        pdf.roundedRect(x, y, width, height, 2, 2, 'FD');
                    };
                    
                    // Helper to check if we need a new page
                    const checkNewPage = (spaceNeeded) => {
                        if (yPos + spaceNeeded > pageHeight - margin) {
                            pdf.addPage();
                            yPos = margin;
                            return true;
                        }
                        return false;
                    };
                    
                    // PAGE 1: Header and Summary
                    pdf.setFillColor(59, 130, 246);
                    pdf.rect(0, 0, pageWidth, 50, 'F');
                    
                    pdf.setFontSize(24);
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('Investment Allocation Report', pageWidth / 2, 25, { align: 'center' });
                    
                    pdf.setFontSize(11);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text('Generated: ' + new Date().toLocaleDateString(), pageWidth / 2, 35, { align: 'center' });
                    
                    yPos = 60;
                    
                    // Portfolio Summary
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('PORTFOLIO SUMMARY', margin, yPos);
                    yPos += 8;
                    
                    addColoredBox(margin, yPos, pageWidth - 2 * margin, 32, [239, 246, 255], [191, 219, 254]);
                    
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(30, 30, 30);
                    yPos += 8;
                    pdf.text('Mode: ' + (mode === 'guided' ? 'Guided Portfolio' : 'Custom Mix'), margin + 5, yPos);
                    yPos += 6;
                    pdf.text('Initial Investment: $' + investmentAmount.toLocaleString('en-US'), margin + 5, yPos);
                    yPos += 6;
                    if (recurringContribution > 0) {
                        pdf.text('Recurring: $' + recurringContribution.toLocaleString('en-US') + ' (' + contributionFrequency + ')', margin + 5, yPos);
                        yPos += 6;
                    }
                    pdf.text('Time Horizon: ' + timeHorizon + ' years | Expected Return: ' + scenarios.expected.toFixed(1) + '% (Range: ' + scenarios.conservative.toFixed(1) + '%-' + scenarios.optimistic.toFixed(1) + '%)', margin + 5, yPos);
                    yPos += 12;
                    
                    // Fund Allocations
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('FUND ALLOCATIONS', margin, yPos);
                    yPos += 8;
                    
                    const colors = [
                        { fill: [239, 246, 255], border: [191, 219, 254], text: [59, 130, 246] },
                        { fill: [243, 244, 246], border: [209, 213, 219], text: [99, 102, 241] },
                        { fill: [236, 253, 245], border: [167, 243, 208], text: [16, 185, 129] },
                        { fill: [240, 253, 244], border: [167, 243, 208], text: [5, 150, 105] },
                        { fill: [254, 252, 232], border: [253, 224, 71], text: [245, 158, 11] },
                        { fill: [254, 242, 242], border: [254, 202, 202], text: [239, 68, 68] }
                    ];
                    
                    fundAllocations.forEach((fund, index) => {
                        checkNewPage(35);
                        
                        const color = colors[index % colors.length];
                        addColoredBox(margin, yPos, pageWidth - 2 * margin, 28, color.fill, color.border);
                        
                        pdf.setFontSize(11);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(color.text[0], color.text[1], color.text[2]);
                        pdf.text(fund.ticker, margin + 5, yPos + 7);
                        
                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(60, 60, 60);
                        pdf.setFontSize(9);
                        pdf.text(fund.fullName, margin + 25, yPos + 7);
                        
                        // Provider
                        pdf.setFillColor(255, 255, 255);
                        pdf.roundedRect(pageWidth - margin - 25, yPos + 4, 20, 5, 1, 1, 'F');
                        pdf.setFontSize(8);
                        pdf.setTextColor(80, 80, 80);
                        pdf.text(fund.provider, pageWidth - margin - 15, yPos + 7, { align: 'center' });
                        
                        pdf.setFontSize(13);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(0, 0, 0);
                        pdf.text('$' + fund.amount.toLocaleString('en-US', { minimumFractionDigits: 2 }), margin + 5, yPos + 15);
                        
                        pdf.setFontSize(10);
                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(100, 100, 100);
                        pdf.text('(' + fund.percentage.toFixed(1) + '%)', margin + 50, yPos + 15);
                        
                        pdf.setFontSize(8);
                        pdf.setTextColor(80, 80, 80);
                        pdf.text('Fee: ' + fund.expenseRatio + '% | Yield: ' + fund.dividendYield + '% | Tax: ' + fund.taxEfficiency + ' | Turnover: ' + fund.turnover + '%', margin + 5, yPos + 22);
                        
                        yPos += 33;
                    });
                    
                    // Cost Analysis
                    checkNewPage(40);
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('COST ANALYSIS', margin, yPos);
                    yPos += 8;
                    
                    const boxWidth = (pageWidth - 2 * margin - 10) / 3;
                    
                    addColoredBox(margin, yPos, boxWidth, 22, [239, 246, 255], [147, 197, 253]);
                    pdf.setFontSize(8);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Weighted Expense Ratio', margin + boxWidth / 2, yPos + 7, { align: 'center' });
                    pdf.setFontSize(16);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(59, 130, 246);
                    pdf.text(weightedExpenseRatio.toFixed(3) + '%', margin + boxWidth / 2, yPos + 16, { align: 'center' });
                    
                    addColoredBox(margin + boxWidth + 5, yPos, boxWidth, 22, [254, 249, 195], [253, 224, 71]);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Annual Cost', margin + boxWidth + 5 + boxWidth / 2, yPos + 7, { align: 'center' });
                    pdf.setFontSize(16);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(245, 158, 11);
                    pdf.text('$' + totalCost.toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + boxWidth + 5 + boxWidth / 2, yPos + 16, { align: 'center' });
                    
                    addColoredBox(margin + 2 * boxWidth + 10, yPos, boxWidth, 22, [254, 242, 242], [252, 165, 165]);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Fees Lost (' + timeHorizon + 'Y)', margin + 2 * boxWidth + 10 + boxWidth / 2, yPos + 7, { align: 'center' });
                    pdf.setFontSize(16);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(239, 68, 68);
                    pdf.text('$' + totalFeesLost.toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + 2 * boxWidth + 10 + boxWidth / 2, yPos + 16, { align: 'center' });
                    
                    yPos += 30;
                    
                    // PAGE 2: Growth Projection
                    pdf.addPage();
                    yPos = margin;
                    
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('GROWTH PROJECTION', margin, yPos);
                    yPos += 8;
                    
                    const growthBoxWidth = (pageWidth - 2 * margin - 15) / 4;
                    
                    addColoredBox(margin, yPos, growthBoxWidth, 22, [239, 246, 255], [147, 197, 253]);
                    pdf.setFontSize(7);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Total Invested', margin + growthBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(30, 30, 30);
                    pdf.text('$' + totalContributed.toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + growthBoxWidth / 2, yPos + 15, { align: 'center' });
                    
                    addColoredBox(margin + growthBoxWidth + 5, yPos, growthBoxWidth, 22, [236, 253, 245], [134, 239, 172]);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Value (' + timeHorizon + 'Y)', margin + growthBoxWidth + 5 + growthBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(16, 185, 129);
                    pdf.text('$' + finalValue.toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + growthBoxWidth + 5 + growthBoxWidth / 2, yPos + 15, { align: 'center' });
                    
                    addColoredBox(margin + 2 * growthBoxWidth + 10, yPos, growthBoxWidth, 22, [243, 232, 255], [196, 181, 253]);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Growth', margin + 2 * growthBoxWidth + 10 + growthBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(147, 51, 234);
                    pdf.text('$' + totalReturn.toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + 2 * growthBoxWidth + 10 + growthBoxWidth / 2, yPos + 15, { align: 'center' });
                    
                    addColoredBox(margin + 3 * growthBoxWidth + 15, yPos, growthBoxWidth, 22, [224, 231, 255], [165, 180, 252]);
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Return', margin + 3 * growthBoxWidth + 15 + growthBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(79, 70, 229);
                    if (totalContributed > 0) {
                        pdf.text(((totalReturn / totalContributed) * 100).toFixed(1) + '%', margin + 3 * growthBoxWidth + 15 + growthBoxWidth / 2, yPos + 15, { align: 'center' });
                    } else {
                        pdf.text('N/A', margin + 3 * growthBoxWidth + 15 + growthBoxWidth / 2, yPos + 15, { align: 'center' });
                    }
                    
                    yPos += 30;
                    
                    // Earnings Breakdown
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text('EARNINGS BREAKDOWN', margin, yPos);
                    yPos += 8;
                    
                    const earningsBoxWidth = (pageWidth - 2 * margin - 10) / 3;
                    
                    addColoredBox(margin, yPos, earningsBoxWidth, 25, [240, 253, 250], [153, 246, 228]);
                    pdf.setFontSize(8);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Dividend Income', margin + earningsBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.setFontSize(13);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(20, 184, 166);
                    pdf.text('$' + totalDividends.toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + earningsBoxWidth / 2, yPos + 15, { align: 'center' });
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(80, 80, 80);
                    pdf.text('Avg ' + growthData.weightedDividendYield.toFixed(2) + '% yield', margin + earningsBoxWidth / 2, yPos + 20, { align: 'center' });
                    
                    addColoredBox(margin + earningsBoxWidth + 5, yPos, earningsBoxWidth, 25, [254, 243, 199], [253, 230, 138]);
                    pdf.setFontSize(8);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Capital Gains', margin + earningsBoxWidth + 5 + earningsBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.setFontSize(13);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(217, 119, 6);
                    pdf.text('$' + capitalGains.toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + earningsBoxWidth + 5 + earningsBoxWidth / 2, yPos + 15, { align: 'center' });
                    if (totalReturn > 0) {
                        pdf.setFontSize(7);
                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(80, 80, 80);
                        pdf.text(((capitalGains / totalReturn) * 100).toFixed(1) + '% of growth', margin + earningsBoxWidth + 5 + earningsBoxWidth / 2, yPos + 20, { align: 'center' });
                    }
                    
                    addColoredBox(margin + 2 * earningsBoxWidth + 10, yPos, earningsBoxWidth, 25, [254, 242, 242], [254, 202, 202]);
                    pdf.setFontSize(8);
                    pdf.setTextColor(100, 100, 100);
                    pdf.text('Last Year Income', margin + 2 * earningsBoxWidth + 10 + earningsBoxWidth / 2, yPos + 6, { align: 'center' });
                    pdf.setFontSize(13);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(220, 38, 38);
                    pdf.text('$' + growthData.dividendIncome[growthData.dividendIncome.length - 1].toLocaleString('en-US', { minimumFractionDigits: 0 }), margin + 2 * earningsBoxWidth + 10 + earningsBoxWidth / 2, yPos + 15, { align: 'center' });
                    pdf.setFontSize(7);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(80, 80, 80);
                    pdf.text('Annual (Year ' + timeHorizon + ')', margin + 2 * earningsBoxWidth + 10 + earningsBoxWidth / 2, yPos + 20, { align: 'center' });
                    
                    yPos += 35;
                    
                    // Charts - with proper waiting for render
                    if (growthChartRef.current) {
                        try {
                            // Wait a bit for chart to be fully rendered
                            await new Promise(resolve => setTimeout(resolve, 500));
                            
                            const chartContainer = growthChartRef.current.parentElement;
                            const canvas = await html2canvas(chartContainer, {
                                scale: 2,
                                backgroundColor: '#ffffff',
                                logging: false,
                                useCORS: true
                            });
                            
                            if (canvas && canvas.width > 0 && canvas.height > 0) {
                                const imgData = canvas.toDataURL('image/png');
                                pdf.addPage();
                                yPos = margin;
                                pdf.setFontSize(14);
                                pdf.setFont('helvetica', 'bold');
                                pdf.setTextColor(0, 0, 0);
                                pdf.text('Growth Projection Chart', margin, yPos);
                                yPos += 10;
                                pdf.addImage(imgData, 'PNG', margin, yPos, pageWidth - 2 * margin, 100);
                                yPos += 110;
                            }
                        } catch (err) {
                            console.log('Could not capture growth chart:', err);
                        }
                    }
                    
                    if (chartRef.current && investmentAmount > 0) {
                        try {
                            await new Promise(resolve => setTimeout(resolve, 500));
                            
                            const chartContainer = chartRef.current.parentElement;
                            const canvas = await html2canvas(chartContainer, {
                                scale: 2,
                                backgroundColor: '#ffffff',
                                logging: false,
                                useCORS: true
                            });
                            
                            if (canvas && canvas.width > 0 && canvas.height > 0) {
                                const imgData = canvas.toDataURL('image/png');
                                
                                if (!growthChartRef.current || yPos < margin + 20) {
                                    pdf.addPage();
                                    yPos = margin;
                                }
                                
                                checkNewPage(90);
                                pdf.setFontSize(14);
                                pdf.setFont('helvetica', 'bold');
                                pdf.setTextColor(0, 0, 0);
                                pdf.text('Portfolio Allocation Chart', margin, yPos);
                                yPos += 10;
                                pdf.addImage(imgData, 'PNG', margin, yPos, pageWidth - 2 * margin, 80);
                            }
                        } catch (err) {
                            console.log('Could not capture allocation chart:', err);
                        }
                    }
                    
                    // Disclaimer
                    pdf.addPage();
                    yPos = margin;
                    
                    addColoredBox(margin, yPos, pageWidth - 2 * margin, 55, [254, 252, 232], [250, 204, 21]);
                    
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(133, 77, 14);
                    pdf.text('IMPORTANT DISCLAIMER', margin + 5, yPos + 10);
                    
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(60, 60, 60);
                    const disclaimer = 'This report is for educational purposes only. Projections are based on assumptions and past performance does not guarantee future results. Investment values can go down as well as up. Tax treatment depends on your individual situation and may change in the future. The expense ratios, dividend yields, and tax efficiency ratings shown are estimates based on current data and may change. This is not financial advice. Consider consulting a qualified financial advisor and tax professional for personalized guidance based on your specific circumstances.';
                    const splitDisclaimer = pdf.splitTextToSize(disclaimer, pageWidth - 2 * margin - 10);
                    pdf.text(splitDisclaimer, margin + 5, yPos + 20);
                    
                    // Footer
                    pdf.setFontSize(8);
                    pdf.setTextColor(150, 150, 150);
                    pdf.text('Generated by Investment Allocation Calculator', pageWidth / 2, pageHeight - 10, { align: 'center' });
                    
                    // Save
                    pdf.save('investment-allocation-report.pdf');
                    
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                } finally {
                    setIsGeneratingPDF(false);
                }
            };

            const sendEmailReport = () => {
                if (!userEmail || !userEmail.includes('@')) {
                    alert('Please enter a valid email address');
                    return;
                }
                
                // Create email body with summary
                const subject = 'My Investment Allocation Report';
                const body = `Investment Allocation Report
Generated: ${new Date().toLocaleDateString()}

PORTFOLIO SUMMARY:
- Mode: ${mode === 'guided' ? 'Guided Portfolio' : 'Custom Mix'}
- Initial Investment: $${investmentAmount.toLocaleString('en-US')}
${recurringContribution > 0 ? `- Recurring: $${recurringContribution.toLocaleString('en-US')} (${contributionFrequency})` : ''}
- Time Horizon: ${timeHorizon} years
- Expected Return: ${scenarios.expected.toFixed(1)}% (Conservative: ${scenarios.conservative.toFixed(1)}%, Optimistic: ${scenarios.optimistic.toFixed(1)}%)

FUND ALLOCATIONS:
${fundAllocations.map(fund => 
    `${fund.ticker} (${fund.provider}): $${fund.amount.toLocaleString('en-US', { minimumFractionDigits: 2 })} (${fund.percentage.toFixed(1)}%)
    Fee: ${fund.expenseRatio}% | Yield: ${fund.dividendYield}% | Tax: ${fund.taxEfficiency}`
).join('\n\n')}

COST ANALYSIS:
- Weighted Expense Ratio: ${weightedExpenseRatio.toFixed(3)}%
- Annual Cost: $${totalCost.toLocaleString('en-US', { minimumFractionDigits: 2 })}
- Fees Lost (${timeHorizon} years): $${totalFeesLost.toLocaleString('en-US', { minimumFractionDigits: 0 })}

GROWTH PROJECTION:
- Total Invested: $${totalContributed.toLocaleString('en-US', { minimumFractionDigits: 0 })}
- Projected Value: $${finalValue.toLocaleString('en-US', { minimumFractionDigits: 0 })}
- Investment Growth: $${totalReturn.toLocaleString('en-US', { minimumFractionDigits: 0 })}
${totalContributed > 0 ? `- Return: ${((totalReturn / totalContributed) * 100).toFixed(1)}%` : ''}

EARNINGS BREAKDOWN:
- Dividend Income: $${totalDividends.toLocaleString('en-US', { minimumFractionDigits: 0 })}
- Capital Gains: $${capitalGains.toLocaleString('en-US', { minimumFractionDigits: 0 })}
- Avg Yield: ${growthData.weightedDividendYield.toFixed(2)}%

---
This report is for educational purposes only. Past performance does not guarantee future results.
Consult a financial advisor for personalized advice.`;

                // Open email client with pre-filled data
                const mailtoLink = `mailto:${userEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoLink;
            };

            const totalCustomAllocation = customFunds.reduce((sum, fund) => sum + fund.allocation, 0);

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-4 md:p-8">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-6">
                            <div className="flex items-center gap-3 mb-2">
                                <TrendingUp className="w-8 h-8 text-blue-600" />
                                <h1 className="text-2xl md:text-3xl font-bold text-gray-800">Investment Allocation Calculator</h1>
                            </div>
                            <p className="text-gray-600 mb-6">Low-cost index fund portfolio builder with growth projections</p>

                            {/* Mode Selector */}
                            <div className="flex gap-4 mb-6">
                                <button
                                    onClick={() => setMode('guided')}
                                    className={`flex-1 p-4 rounded-lg border-2 transition-all ${
                                        mode === 'guided'
                                            ? 'border-blue-500 bg-blue-50'
                                            : 'border-gray-300 hover:border-gray-400'
                                    }`}
                                >
                                    <div className="flex items-center justify-center gap-2 mb-2">
                                        <Sparkles className="w-5 h-5" />
                                        <span className="font-semibold">Guided Portfolios</span>
                                    </div>
                                    <p className="text-sm text-gray-600">Choose from pre-built strategies</p>
                                </button>
                                <button
                                    onClick={() => setMode('custom')}
                                    className={`flex-1 p-4 rounded-lg border-2 transition-all ${
                                        mode === 'custom'
                                            ? 'border-blue-500 bg-blue-50'
                                            : 'border-gray-300 hover:border-gray-400'
                                    }`}
                                >
                                    <div className="flex items-center justify-center gap-2 mb-2">
                                        <Sliders className="w-5 h-5" />
                                        <span className="font-semibold">Custom Mix</span>
                                    </div>
                                    <p className="text-sm text-gray-600">Build your own allocation</p>
                                </button>
                            </div>

                            {/* Investment Amount Input */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        <DollarSign className="inline w-4 h-4 mr-1" />
                                        Initial Investment (Optional - can be $0)
                                    </label>
                                    <input
                                        type="number"
                                        value={investmentAmount}
                                        onChange={(e) => {
                                            const value = e.target.value;
                                            if (value === '') {
                                                setInvestmentAmount(0);
                                            } else {
                                                setInvestmentAmount(Number(value));
                                            }
                                        }}
                                        onBlur={(e) => {
                                            const value = Number(e.target.value);
                                            if (value < 0) setInvestmentAmount(0);
                                        }}
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg font-semibold focus:border-blue-500 focus:outline-none"
                                        min="0"
                                        step="1000"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        👤 Your Current Age
                                    </label>
                                    <input
                                        type="number"
                                        value={age}
                                        onChange={(e) => {
                                            const value = e.target.value;
                                            if (value === '') {
                                                setAge('');
                                            } else {
                                                setAge(Number(value));
                                            }
                                        }}
                                        onBlur={(e) => {
                                            // Only ensure it's a valid number, no min/max restrictions
                                            const value = e.target.value;
                                            if (value === '' || isNaN(Number(value))) {
                                                setAge(30); // Default only if completely invalid
                                            }
                                        }}
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-lg font-semibold focus:border-blue-500 focus:outline-none"
                                        min="1"
                                        max="120"
                                        placeholder="30"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">
                                        Helps suggest bond allocation (Rule of 110: ~{recommendedBondAllocation}% bonds recommended)
                                    </p>
                                </div>
                            </div>

                            {mode === 'guided' ? (
                                <>
                                    {/* Portfolio Selection */}
                                    <div className="mb-6">
                                        <label className="block text-sm font-semibold text-gray-700 mb-3">
                                            Portfolio Strategy
                                        </label>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {guidedPortfolios.map((portfolio, index) => (
                                                <button
                                                    key={index}
                                                    onClick={() => setSelectedPortfolio(index)}
                                                    className={`p-4 rounded-lg border-2 transition-all text-left relative ${
                                                        selectedPortfolio === index
                                                            ? 'border-blue-500 bg-blue-50'
                                                            : 'border-gray-300 hover:border-gray-400'
                                                    }`}
                                                >
                                                    {index === lowestIndex && (
                                                        <div className="absolute -top-2 -right-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                                                            LOWEST FEES
                                                        </div>
                                                    )}
                                                    <div className="flex justify-between items-start mb-1">
                                                        <div className="font-semibold text-gray-800">{portfolio.name}</div>
                                                        <span className="text-xs bg-gray-200 px-2 py-1 rounded">{portfolio.complexity}</span>
                                                    </div>
                                                    <div className="text-sm text-gray-600 mb-2">{portfolio.description}</div>
                                                    <div className="text-xs text-gray-500">
                                                        {portfolio.funds.map(f => f.ticker).join(' + ')}
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Allocation Slider */}
                                    <div className="mb-6">
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            <Percent className="inline w-4 h-4 mr-1" />
                                            US / International Split {guidedPortfolios[selectedPortfolio].hasBonds && `(${stockAllocation}% stocks)`}
                                        </label>
                                        <div className="flex items-center gap-4">
                                            <span className="text-sm font-medium text-blue-600 w-16">{usAllocation}% US</span>
                                            <input
                                                type="range"
                                                min="0"
                                                max={stockAllocation}
                                                value={usAllocation}
                                                onChange={(e) => setUsAllocation(Number(e.target.value))}
                                                className="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                            />
                                            <span className="text-sm font-medium text-green-600 w-24">{internationalAllocation}% Intl</span>
                                        </div>
                                    </div>
                                    
                                    {/* Bond Allocation Slider (shows for 3-fund portfolios) */}
                                    {guidedPortfolios[selectedPortfolio].hasBonds && (
                                        <div className="mb-6 bg-amber-50 border-2 border-amber-200 rounded-lg p-4">
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                🏛️ Bond Allocation
                                            </label>
                                            <div className="flex items-center gap-4 mb-2">
                                                <span className="text-sm font-medium text-amber-700 w-20">{bondAllocation}% Bonds</span>
                                                <input
                                                    type="range"
                                                    min="0"
                                                    max="80"
                                                    value={bondAllocation}
                                                    onChange={(e) => setBondAllocation(Number(e.target.value))}
                                                    className="flex-1 h-2 bg-amber-200 rounded-lg appearance-none cursor-pointer"
                                                />
                                                <span className="text-sm font-medium text-blue-600 w-24">{stockAllocation}% Stocks</span>
                                            </div>
                                            <div className="flex justify-between items-center text-xs">
                                                <span className="text-gray-600">
                                                    Recommended for age {age}: <span className="font-semibold text-amber-700">{recommendedBondAllocation}%</span>
                                                </span>
                                                <button
                                                    onClick={() => setBondAllocation(recommendedBondAllocation)}
                                                    className="text-blue-600 hover:text-blue-700 font-medium underline"
                                                >
                                                    Use recommended
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </>
                            ) : (
                                <>
                                    {/* Custom Fund Selection */}
                                    <div className="mb-6">
                                        <label className="block text-sm font-semibold text-gray-700 mb-3">
                                            Build Your Portfolio
                                        </label>
                                        <div className="mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                            <p className="text-sm text-blue-800">
                                                <span className="font-semibold">📚 20+ Low-Cost ETFs Available:</span> Choose from Vanguard, Schwab, iShares (BlackRock), and SPDR funds. All have expense ratios under 0.11% and excellent tax efficiency.
                                            </p>
                                        </div>
                                        <div className="space-y-3">
                                            {customFunds.map((fund, index) => {
                                                const selectedEtf = etfs[fund.ticker.toLowerCase()];
                                                return (
                                                    <div key={index} className="border-2 border-gray-200 rounded-lg p-3">
                                                        <div className="flex gap-3 items-start mb-2">
                                                            <select
                                                                value={fund.ticker}
                                                                onChange={(e) => updateCustomFund(index, 'ticker', e.target.value)}
                                                                className="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm"
                                                            >
                                                                <optgroup label="Vanguard ETFs">
                                                                    {Object.keys(etfs).filter(key => etfs[key].provider === 'Vanguard').map(key => (
                                                                        <option key={key} value={key.toUpperCase()}>
                                                                            {key.toUpperCase()} - {etfs[key].fullName} ({etfs[key].expenseRatio}%)
                                                                        </option>
                                                                    ))}
                                                                </optgroup>
                                                                <optgroup label="Schwab ETFs">
                                                                    {Object.keys(etfs).filter(key => etfs[key].provider === 'Schwab').map(key => (
                                                                        <option key={key} value={key.toUpperCase()}>
                                                                            {key.toUpperCase()} - {etfs[key].fullName} ({etfs[key].expenseRatio}%)
                                                                        </option>
                                                                    ))}
                                                                </optgroup>
                                                                <optgroup label="iShares ETFs (BlackRock)">
                                                                    {Object.keys(etfs).filter(key => etfs[key].provider === 'iShares').map(key => (
                                                                        <option key={key} value={key.toUpperCase()}>
                                                                            {key.toUpperCase()} - {etfs[key].fullName} ({etfs[key].expenseRatio}%)
                                                                        </option>
                                                                    ))}
                                                                </optgroup>
                                                                <optgroup label="SPDR ETFs (State Street)">
                                                                    {Object.keys(etfs).filter(key => etfs[key].provider === 'SPDR').map(key => (
                                                                        <option key={key} value={key.toUpperCase()}>
                                                                            {key.toUpperCase()} - {etfs[key].fullName} ({etfs[key].expenseRatio}%)
                                                                        </option>
                                                                    ))}
                                                                </optgroup>
                                                            </select>
                                                            <input
                                                                type="number"
                                                                value={fund.allocation}
                                                                onChange={(e) => updateCustomFund(index, 'allocation', Math.max(0, Math.min(100, Number(e.target.value))))}
                                                                className="w-24 px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-sm"
                                                                min="0"
                                                                max="100"
                                                            />
                                                            <span className="text-sm font-medium mt-2">%</span>
                                                            {customFunds.length > 1 && (
                                                                <button
                                                                    onClick={() => removeCustomFund(index)}
                                                                    className="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-colors text-sm"
                                                                >
                                                                    Remove
                                                                </button>
                                                            )}
                                                        </div>
                                                        {selectedEtf && (
                                                            <div className="text-xs text-gray-600 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-2 bg-gray-50 p-2 rounded">
                                                                <div>
                                                                    <span className="font-semibold">Fee:</span> {selectedEtf.expenseRatio}%
                                                                </div>
                                                                <div>
                                                                    <span className="font-semibold">Yield:</span> {selectedEtf.dividendYield}%
                                                                </div>
                                                                <div>
                                                                    <span className="font-semibold">Tax:</span> {selectedEtf.taxEfficiency}
                                                                </div>
                                                                <div>
                                                                    <span className="font-semibold">Turnover:</span> {selectedEtf.turnover}%
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        <div className="flex gap-3 mt-3">
                                            <button
                                                onClick={addCustomFund}
                                                disabled={customFunds.length >= Object.keys(etfs).length}
                                                className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                            >
                                                Add Fund
                                            </button>
                                            {totalCustomAllocation !== 100 && (
                                                <button
                                                    onClick={normalizeAllocations}
                                                    className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
                                                >
                                                    Split Evenly (100%)
                                                </button>
                                            )}
                                        </div>
                                        {totalCustomAllocation !== 100 && (
                                            <p className="text-sm text-orange-600 mt-2">
                                                Total: {totalCustomAllocation}% (should equal 100%)
                                            </p>
                                        )}
                                    </div>
                                </>
                            )}

                            {/* Growth Assumptions */}
                            <div className="mb-6">
                                {/* Expected Return Scenarios Display */}
                                <div className="mb-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-4">
                                    <div className="flex items-center justify-between mb-2">
                                        <div className="flex items-center gap-2">
                                            <TrendingUp className="w-5 h-5 text-blue-600" />
                                            <span className="font-semibold text-gray-800">Projected Returns (Based on Your Allocation)</span>
                                        </div>
                                        <div className="text-xs text-gray-600 bg-white px-2 py-1 rounded">
                                            {stockAllocation}% stocks / {bondAllocation}% bonds
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-center">
                                        <div className="bg-white rounded p-2 border border-orange-200">
                                            <div className="text-xs text-gray-600">🐢 Conservative</div>
                                            <div className="text-lg font-bold text-orange-600">{scenarios.conservative.toFixed(1)}%</div>
                                        </div>
                                        <div className="bg-white rounded p-2 border-2 border-blue-400">
                                            <div className="text-xs text-gray-600">🎯 Expected</div>
                                            <div className="text-lg font-bold text-blue-700">{scenarios.expected.toFixed(1)}%</div>
                                        </div>
                                        <div className="bg-white rounded p-2 border border-green-200">
                                            <div className="text-xs text-gray-600">🚀 Optimistic</div>
                                            <div className="text-lg font-bold text-green-600">{scenarios.optimistic.toFixed(1)}%</div>
                                        </div>
                                        <div className="bg-white rounded p-2 border border-red-300">
                                            <div className="text-xs text-gray-600">💥 Crisis</div>
                                            <div className="text-lg font-bold text-red-600">{scenarios.crisis.toFixed(1)}%</div>
                                        </div>
                                    </div>
                                    <p className="text-xs text-gray-600 mt-2">
                                        Returns calculated using: Stocks ~10%, Bonds ~4% (historical averages)
                                    </p>
                                </div>
                                
                                {/* Time Horizon */}
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        Time Horizon (Years)
                                    </label>
                                    <input
                                        type="number"
                                        value={timeHorizon}
                                        onChange={(e) => {
                                            const value = e.target.value;
                                            if (value === '') {
                                                setTimeHorizon(1);
                                            } else {
                                                const numValue = Number(value);
                                                setTimeHorizon(numValue);
                                            }
                                        }}
                                        onBlur={(e) => {
                                            const value = Number(e.target.value);
                                            if (value < 1) setTimeHorizon(1);
                                            if (value > 40) setTimeHorizon(40);
                                        }}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                        min="1"
                                        max="40"
                                    />
                                </div>
                            </div>

                            {/* Dollar-Cost Averaging Section */}
                            <div className="border-t-2 border-gray-200 pt-6">
                                <h3 className="text-lg font-semibold text-gray-800 mb-4">💰 Dollar-Cost Averaging</h3>
                                <p className="text-sm text-gray-600 mb-4">Add regular contributions (daily, weekly, monthly, etc.) to see how consistently investing over time accelerates growth</p>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Recurring Contribution Amount ($)
                                        </label>
                                        <input
                                            type="text"
                                            value={recurringContribution === 0 ? '' : recurringContribution}
                                            onChange={(e) => {
                                                const value = e.target.value.replace(/[^0-9]/g, '');
                                                setRecurringContribution(value === '' ? 0 : Number(value));
                                            }}
                                            className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                            placeholder="0"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Contribution Frequency
                                        </label>
                                        <select
                                            value={contributionFrequency}
                                            onChange={(e) => setContributionFrequency(e.target.value)}
                                            className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                                        >
                                            <option value="daily">Business Daily (Mon-Fri)</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="quarterly">Quarterly</option>
                                            <option value="annually">Annually</option>
                                        </select>
                                    </div>
                                </div>

                                {recurringContribution > 0 && (
                                    <div className="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                        <p className="text-sm text-blue-800">
                                            <span className="font-semibold">Total contributions over {timeHorizon} years:</span> ${totalContributed.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                            {investmentAmount > 0 
                                                ? ` ($${investmentAmount.toLocaleString('en-US')} initial + $${(totalContributed - investmentAmount).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} in recurring contributions)`
                                                : ` (All from ${contributionFrequency} contributions)`
                                            }
                                        </p>
                                    </div>
                                )}

                                {investmentAmount === 0 && recurringContribution === 0 && (
                                    <div className="mt-3 p-3 bg-orange-50 rounded-lg border border-orange-200">
                                        <p className="text-sm text-orange-800">
                                            <span className="font-semibold">💡 Tip:</span> Set an initial investment amount or add recurring contributions to see your portfolio grow!
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Results Grid */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            {/* Allocation Breakdown */}
                            <div className="bg-white rounded-2xl shadow-xl p-6">
                                <h2 className="text-xl font-bold text-gray-800 mb-4">Your Portfolio</h2>
                                
                                {investmentAmount > 0 ? (
                                    <>
                                        <div className="h-64 mb-6 flex items-center justify-center">
                                            <canvas ref={chartRef} style={{maxHeight: '250px'}}></canvas>
                                        </div>

                                        <div className="space-y-4">
                                            {fundAllocations.map((fund, index) => {
                                                const borderColors = ['border-blue-500', 'border-indigo-500', 'border-green-500', 'border-emerald-500', 'border-yellow-500', 'border-red-500'];
                                                const bgColors = ['bg-blue-50', 'bg-indigo-50', 'bg-green-50', 'bg-emerald-50', 'bg-yellow-50', 'bg-red-50'];
                                                
                                                return (
                                                    <div key={index} className={`border-l-4 ${borderColors[index]} pl-4 py-2 ${bgColors[index]} rounded-r`}>
                                                        <div className="flex justify-between items-start mb-1">
                                                            <div className="text-sm text-gray-600 font-medium">{fund.ticker} - {fund.fullName}</div>
                                                            <span className="text-xs bg-white px-2 py-1 rounded font-semibold text-gray-700">{fund.provider}</span>
                                                        </div>
                                                        <div className="text-2xl font-bold text-gray-800">
                                                            ${fund.amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                        </div>
                                                        <div className="text-xs text-gray-500 mt-2 grid grid-cols-1 sm:grid-cols-2 gap-x-3 gap-y-1">
                                                            <div><span className="font-semibold">Allocation:</span> {fund.percentage.toFixed(1)}%</div>
                                                            <div><span className="font-semibold">Fee:</span> {fund.expenseRatio}%</div>
                                                            <div><span className="font-semibold">Yield:</span> {fund.dividendYield}%</div>
                                                            <div><span className="font-semibold">Tax:</span> {fund.taxEfficiency}</div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </>
                                ) : (
                                    <div className="h-64 mb-6 flex items-center justify-center">
                                        <div className="text-center p-8 bg-gray-50 rounded-lg">
                                            <p className="text-gray-600 mb-2">No initial investment</p>
                                            <p className="text-sm text-gray-500">Your portfolio will build through recurring contributions</p>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Cost Analysis */}
                            <div className="bg-white rounded-2xl shadow-xl p-6">
                                <h2 className="text-xl font-bold text-gray-800 mb-4">Cost Analysis</h2>
                                
                                <div className="space-y-6">
                                    <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl">
                                        <div className="text-sm text-gray-600 mb-1">Weighted Expense Ratio</div>
                                        <div className="text-4xl font-bold text-blue-600">
                                            {weightedExpenseRatio.toFixed(3)}%
                                        </div>
                                        <div className="text-xs text-gray-500 mt-2">Blended annual cost</div>
                                    </div>

                                    <div>
                                        <div className="flex justify-between items-center mb-3">
                                            <span className="text-sm font-semibold text-gray-700">Annual Costs Breakdown</span>
                                        </div>
                                        
                                        <div className="space-y-3">
                                            {fundAllocations.map((fund, index) => (
                                                <div key={index} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                    <span className="text-sm text-gray-600">{fund.ticker} annual fee</span>
                                                    <span className="font-semibold text-gray-800">
                                                        ${fund.cost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                    </span>
                                                </div>
                                            ))}
                                            
                                            <div className="flex justify-between items-center p-3 bg-blue-100 rounded-lg border-2 border-blue-300">
                                                <span className="text-sm font-bold text-gray-800">Total Annual Cost</span>
                                                <span className="text-lg font-bold text-blue-600">
                                                    ${totalCost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-orange-50 p-4 rounded-lg border border-orange-200">
                                        <div className="flex items-start gap-2">
                                            <Info className="w-5 h-5 text-orange-600 mt-0.5 flex-shrink-0" />
                                            <div>
                                                <div className="text-sm font-semibold text-orange-900 mb-1">Lost to Fees Over {timeHorizon} Years</div>
                                                <div className="text-2xl font-bold text-orange-600">
                                                    ${totalFeesLost.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                                </div>
                                                <div className="text-xs text-orange-700 mt-1">
                                                    Growth you're giving up to expenses
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-red-50 p-4 rounded-lg border-2 border-red-300">
                                        <div className="flex items-start gap-2">
                                            <Info className="w-5 h-5 text-red-600 mt-0.5 flex-shrink-0" />
                                            <div className="flex-1">
                                                <div className="text-sm font-semibold text-red-900 mb-1">vs. Financial Advisor (1% Fee)</div>
                                                <div className="text-3xl font-bold text-red-600">
                                                    ${totalAdvisorFeesLost.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                                </div>
                                                <div className="text-xs text-red-700 mt-1">
                                                    You'd lose this much more vs. low-cost ETFs
                                                </div>
                                                <div className="mt-2 pt-2 border-t border-red-200">
                                                    <div className="text-xs text-gray-700">
                                                        <span className="font-semibold">Savings with ETFs:</span> {totalAdvisorFeesLost > totalFeesLost ? (((totalAdvisorFeesLost - totalFeesLost) / totalAdvisorFeesLost) * 100).toFixed(1) : 0}% less in fees
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Growth Projection */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">Growth Projection</h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <div className="text-sm text-gray-600 mb-1">Total Invested</div>
                                    <div className="text-2xl font-bold text-gray-800">
                                        ${totalContributed.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        Your contributions
                                    </div>
                                </div>
                                <div className="bg-green-50 p-4 rounded-lg">
                                    <div className="text-sm text-gray-600 mb-1">Projected Value ({timeHorizon} years)</div>
                                    <div className="text-2xl font-bold text-green-600">
                                        ${finalValue.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        Total portfolio value
                                    </div>
                                </div>
                                <div className="bg-purple-50 p-4 rounded-lg">
                                    <div className="text-sm text-gray-600 mb-1">Investment Growth</div>
                                    <div className="text-2xl font-bold text-purple-600">
                                        ${totalReturn.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        {totalContributed > 0 ? `${((totalReturn / totalContributed) * 100).toFixed(1)}% return` : 'N/A'}
                                    </div>
                                </div>
                                <div className="bg-indigo-50 p-4 rounded-lg">
                                    <div className="text-sm text-gray-600 mb-1">Growth vs Contributions</div>
                                    <div className="text-2xl font-bold text-indigo-600">
                                        {finalValue > 0 ? `${((totalReturn / finalValue) * 100).toFixed(1)}%` : '0%'}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        From market growth
                                    </div>
                                </div>
                            </div>

                            {/* Earnings Breakdown */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div className="bg-teal-50 p-4 rounded-lg border-2 border-teal-200">
                                    <div className="text-sm text-gray-600 mb-1">💰 Estimated Dividend Income</div>
                                    <div className="text-2xl font-bold text-teal-600">
                                        ${totalDividends.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        Avg yield: {growthData.weightedDividendYield.toFixed(2)}% • Qualified dividends
                                    </div>
                                </div>
                                <div className="bg-amber-50 p-4 rounded-lg border-2 border-amber-200">
                                    <div className="text-sm text-gray-600 mb-1">📈 Estimated Capital Gains</div>
                                    <div className="text-2xl font-bold text-amber-600">
                                        ${capitalGains.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        {totalReturn > 0 ? `${((capitalGains / totalReturn) * 100).toFixed(1)}% of growth` : 'N/A'} • Long-term rate eligible
                                    </div>
                                </div>
                                <div className="bg-rose-50 p-4 rounded-lg border-2 border-rose-200">
                                    <div className="text-sm text-gray-600 mb-1">💸 Last Year Dividend Income</div>
                                    <div className="text-2xl font-bold text-rose-600">
                                        ${growthData.dividendIncome[growthData.dividendIncome.length - 1].toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">
                                        Annual income in year {timeHorizon}
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-4">
                                {/* Left side: Chart and Insights */}
                                <div className="lg:col-span-3 space-y-4">
                                    {/* Chart */}
                                    <div className="h-80">
                                        <canvas ref={growthChartRef}></canvas>
                                    </div>
                                    
                                    {/* Key Insights Cards */}
                                    <div className="grid grid-cols-2 gap-4">
                                        {/* Expected Return Range */}
                                        <div className="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-lg p-5">
                                            <div className="text-xs text-gray-600 mb-2">📈 Expected Return</div>
                                            <div className="text-3xl font-bold text-blue-700 mb-1">
                                                {scenarios.expected.toFixed(1)}%
                                            </div>
                                            <div className="text-xs text-gray-500">
                                                Range: {scenarios.conservative.toFixed(1)}% - {scenarios.optimistic.toFixed(1)}%
                                            </div>
                                        </div>
                                        
                                        {/* Projected Value Range */}
                                        <div className="bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-200 rounded-lg p-5">
                                            <div className="text-xs text-gray-600 mb-2">💰 Final Value Range</div>
                                            <div className="text-2xl font-bold text-purple-700 mb-1">
                                                ${finalValue >= 1000000 
                                                    ? (finalValue / 1000000).toFixed(1) + 'M' 
                                                    : (finalValue / 1000).toFixed(0) + 'K'}
                                            </div>
                                            <div className="text-xs text-gray-500">
                                                ${(() => {
                                                    const conservativeVal = growthDataConservative.values[growthDataConservative.values.length - 1];
                                                    const optimisticVal = growthDataOptimistic.values[growthDataOptimistic.values.length - 1];
                                                    const formatVal = (val) => val >= 1000000 
                                                        ? (val / 1000000).toFixed(1) + 'M' 
                                                        : (val / 1000).toFixed(0) + 'K';
                                                    return `${formatVal(conservativeVal)} - ${formatVal(optimisticVal)} range`;
                                                })()}
                                            </div>
                                        </div>
                                        
                                        {/* Total Dividend Income */}
                                        <div className="bg-gradient-to-br from-amber-50 to-amber-100 border-2 border-amber-200 rounded-lg p-5">
                                            <div className="text-xs text-gray-600 mb-2">💵 Total Dividend Income</div>
                                            <div className="text-3xl font-bold text-amber-700 mb-1">
                                                ${totalDividends >= 1000000 
                                                    ? (totalDividends / 1000000).toFixed(1) + 'M' 
                                                    : (totalDividends / 1000).toFixed(0) + 'K'}
                                            </div>
                                            <div className="text-xs text-gray-500">
                                                Over {timeHorizon} years
                                            </div>
                                        </div>
                                        
                                        {/* Market Risk Level */}
                                        <div className="bg-gradient-to-br from-rose-50 to-rose-100 border-2 border-rose-200 rounded-lg p-5">
                                            <div className="text-xs text-gray-600 mb-2">🎲 Portfolio Risk</div>
                                            <div className="text-3xl font-bold text-rose-700 mb-1">
                                                {usAllocation >= 80 ? 'Moderate' : usAllocation >= 60 ? 'Balanced' : 'Conservative'}
                                            </div>
                                            <div className="text-xs text-gray-500">
                                                {usAllocation}% US / {internationalAllocation}% Intl
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Comparison to Average American */}
                                <div className="lg:col-span-2 bg-gradient-to-br from-emerald-50 to-teal-50 border-2 border-emerald-200 rounded-xl p-6 flex flex-col justify-between">
                                    <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                        <Sparkles className="w-5 h-5 text-emerald-600" />
                                        How You Compare
                                    </h3>
                                    
                                    {(() => {
                                        // Average US household retirement savings by age (2024 data)
                                        const usAverageSavings = {
                                            'Under 35': { median: 18880, average: 49130 },
                                            '35-44': { median: 45000, average: 141520 },
                                            '45-54': { median: 115000, average: 313220 },
                                            '55-64': { median: 185000, average: 537560 },
                                            '65-74': { median: 200000, average: 609230 },
                                            '75+': { median: 130000, average: 462410 }
                                        };
                                        
                                        // Estimate age bracket based on time horizon
                                        let projectedAge = '';
                                        let benchmarkData = { median: 0, average: 0 };
                                        
                                        if (timeHorizon <= 5) {
                                            projectedAge = 'Under 35';
                                            benchmarkData = usAverageSavings['Under 35'];
                                        } else if (timeHorizon <= 15) {
                                            projectedAge = '35-44';
                                            benchmarkData = usAverageSavings['35-44'];
                                        } else if (timeHorizon <= 25) {
                                            projectedAge = '45-54';
                                            benchmarkData = usAverageSavings['45-54'];
                                        } else if (timeHorizon <= 35) {
                                            projectedAge = '55-64';
                                            benchmarkData = usAverageSavings['55-64'];
                                        } else {
                                            projectedAge = '65-74';
                                            benchmarkData = usAverageSavings['65-74'];
                                        }
                                        
                                        // Calculate inflation-adjusted value for fair comparison to today's benchmarks
                                        const realValue = finalValue / Math.pow(1 + inflationRate, timeHorizon);
                                        const vsMedian = realValue / benchmarkData.median;
                                        const vsAverage = realValue / benchmarkData.average;
                                        
                                        // Calculate percentile (simplified approximation using real dollars)
                                        let percentile = 50;
                                        if (realValue >= benchmarkData.average) {
                                            percentile = 75 + Math.min(25, (realValue / benchmarkData.average - 1) * 10);
                                        } else if (realValue >= benchmarkData.median) {
                                            percentile = 50 + ((realValue - benchmarkData.median) / (benchmarkData.average - benchmarkData.median)) * 25;
                                        } else {
                                            percentile = (realValue / benchmarkData.median) * 50;
                                        }
                                        percentile = Math.min(99, Math.max(1, percentile));
                                        
                                        return (
                                            <>
                                                <div className="mb-6">
                                                    <div className="text-xs text-gray-600 mb-2">Your projected portfolio value:</div>
                                                    <div className="text-4xl font-bold text-emerald-600 mb-1">
                                                        ${finalValue >= 1000000 
                                                            ? (finalValue / 1000000).toFixed(1) + 'M' 
                                                            : (finalValue / 1000).toFixed(0) + 'K'}
                                                    </div>
                                                    <div className="text-xs text-gray-500">
                                                        in {timeHorizon} years
                                                        <span className="block text-emerald-700 font-semibold mt-1">
                                                            ≈ ${realValue >= 1000000 
                                                                ? (realValue / 1000000).toFixed(1) + 'M' 
                                                                : (realValue / 1000).toFixed(0) + 'K'} in today's dollars
                                                        </span>
                                                    </div>
                                                </div>
                                                
                                                <div className="mb-6 pb-6 border-b border-emerald-200">
                                                    <div className="text-xs text-gray-600 mb-2">Estimated Percentile:</div>
                                                    <div className="text-5xl font-bold text-emerald-700 mb-2">
                                                        {percentile.toFixed(0)}th
                                                    </div>
                                                    <div className="text-sm text-gray-600">
                                                        {percentile >= 75 ? '🎉 Top quartile!' : percentile >= 50 ? '✨ Above average' : '📈 Keep building'}
                                                    </div>
                                                </div>
                                                
                                                <div className="space-y-4 flex-grow">
                                                    {(() => {
                                                        // Helper function to format large numbers
                                                        const formatValue = (val) => {
                                                            if (val >= 1000000) {
                                                                return '$' + (val / 1000000).toFixed(1) + 'M';
                                                            } else {
                                                                return '$' + (val / 1000).toFixed(0) + 'K';
                                                            }
                                                        };
                                                        
                                                        return (
                                                            <>
                                                                <div>
                                                                    <div className="flex justify-between items-center mb-1">
                                                                        <span className="text-xs text-gray-600">US Median (Age {projectedAge})</span>
                                                                        <span className="text-xs font-semibold text-gray-700">{formatValue(benchmarkData.median)}</span>
                                                                    </div>
                                                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                                                        <div 
                                                                            className="bg-blue-400 h-2 rounded-full" 
                                                                            style={{ width: '50%' }}
                                                                        ></div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div>
                                                                    <div className="flex justify-between items-center mb-1">
                                                                        <span className="text-xs text-gray-600">You</span>
                                                                        <span className="text-xs font-bold text-emerald-700">{formatValue(realValue)}</span>
                                                                    </div>
                                                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                                                        <div 
                                                                            className="bg-emerald-500 h-2 rounded-full" 
                                                                            style={{ width: Math.min(100, (realValue / benchmarkData.average) * 50) + '%' }}
                                                                        ></div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div>
                                                                    <div className="flex justify-between items-center mb-1">
                                                                        <span className="text-xs text-gray-600">US Average (Age {projectedAge})</span>
                                                                        <span className="text-xs font-semibold text-gray-700">{formatValue(benchmarkData.average)}</span>
                                                                    </div>
                                                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                                                        <div 
                                                                            className="bg-purple-400 h-2 rounded-full" 
                                                                            style={{ width: '100%' }}
                                                                        ></div>
                                                                    </div>
                                                                </div>
                                                            </>
                                                        );
                                                    })()}
                                                </div>
                                                
                                                <div className="mt-6 pt-6 border-t border-emerald-200">
                                                    <div className="text-sm text-gray-600">
                                                        {vsMedian >= 1 ? (
                                                            <>You'll have <span className="font-bold text-emerald-700">{vsMedian.toFixed(1)}x</span> the median savings</>
                                                        ) : (
                                                            <>Keep contributing to reach the median</>
                                                        )}
                                                    </div>
                                                </div>
                                            </>
                                        );
                                    })()}
                                </div>
                            </div>

                            <p className="text-xs text-gray-500 mt-4">
                                * Assumes {scenarios.expected.toFixed(1)}% expected annual return before fees (range: {scenarios.conservative.toFixed(1)}%-{scenarios.optimistic.toFixed(1)}%){recurringContribution > 0 ? `, with ${contributionFrequency} contributions of $${recurringContribution.toLocaleString('en-US')}` : ', no additional contributions'}. 
                                Dividend estimates based on current yields ({growthData.weightedDividendYield.toFixed(2)}% avg). US savings data from Federal Reserve Survey of Consumer Finances 2024. 
                                Comparisons use inflation-adjusted values (assuming {(inflationRate * 100).toFixed(0)}% annual inflation) for fair comparison to today's benchmarks. Past performance does not guarantee future results.
                            </p>
                        </div>

                        {/* Stress Test & Crisis Scenarios Section */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div 
                                className="flex items-center justify-between cursor-pointer"
                                onClick={() => setStressTestExpanded(!stressTestExpanded)}
                            >
                                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    🎲 Stress Test & Crisis Scenarios
                                    <span className="hidden sm:inline text-sm font-normal text-gray-600">
                                        How does your portfolio handle real-world disasters?
                                    </span>
                                </h2>
                                <button className="text-2xl text-gray-600 hover:text-gray-800">
                                    {stressTestExpanded ? '−' : '+'}
                                </button>
                            </div>
                            
                            {stressTestExpanded && (
                                <div className="mt-6">
                                    {/* Tab Navigation */}
                                    <div className="flex flex-wrap gap-2 mb-6 border-b-2 border-gray-200">
                                        <button
                                            onClick={() => setStressTestTab('historical')}
                                            className={`px-3 py-2 text-sm sm:text-base font-semibold transition-all ${
                                                stressTestTab === 'historical'
                                                    ? 'text-blue-600 border-b-2 border-blue-600 -mb-[2px]'
                                                    : 'text-gray-600 hover:text-gray-800'
                                            }`}
                                        >
                                            📊 Historical Crises
                                        </button>
                                        <button
                                            onClick={() => setStressTestTab('what-if')}
                                            className={`px-3 py-2 text-sm sm:text-base font-semibold transition-all ${
                                                stressTestTab === 'what-if'
                                                    ? 'text-blue-600 border-b-2 border-blue-600 -mb-[2px]'
                                                    : 'text-gray-600 hover:text-gray-800'
                                            }`}
                                        >
                                            💥 What-If Scenarios
                                        </button>
                                        <button
                                            onClick={() => setStressTestTab('vs-cash')}
                                            className={`px-3 py-2 text-sm sm:text-base font-semibold transition-all ${
                                                stressTestTab === 'vs-cash'
                                                    ? 'text-blue-600 border-b-2 border-blue-600 -mb-[2px]'
                                                    : 'text-gray-600 hover:text-gray-800'
                                            }`}
                                        >
                                            💵 vs. Cash/Inflation
                                        </button>
                                    </div>

                                    {/* Historical Crises Tab */}
                                    {stressTestTab === 'historical' && (
                                        <div className="space-y-4">
                                            <p className="text-sm text-gray-600 mb-4">
                                                See how your portfolio would perform through major historical market crashes, 
                                                then recover over the remaining years. Based on actual historical returns.
                                            </p>
                                            
                                            {/* 2008 Financial Crisis */}
                                            <div className="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-200 rounded-lg p-5">
                                                <div className="flex items-center justify-between mb-3">
                                                    <h3 className="font-bold text-gray-800 text-lg">💣 2008 Financial Crisis</h3>
                                                    <span className="text-xs bg-red-100 px-2 py-1 rounded font-semibold text-red-700">
                                                        Actual Historical Returns
                                                    </span>
                                                </div>
                                                <p className="text-sm text-gray-700 mb-3">
                                                    Year 1: -37% crash, then gradual recovery. Used actual S&P 500 returns (2008-2017).
                                                </p>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <div className="text-xs text-gray-600">Final Value</div>
                                                        <div className="text-2xl font-bold text-red-700">
                                                            ${crisis2008.finalValue >= 1000000 
                                                                ? (crisis2008.finalValue / 1000000).toFixed(1) + 'M' 
                                                                : (crisis2008.finalValue / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-gray-500">
                                                            {((crisis2008.finalValue / finalValue - 1) * 100).toFixed(1)}% vs. expected
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">Total Growth</div>
                                                        <div className="text-2xl font-bold text-green-600">
                                                            ${(crisis2008.finalValue - crisis2008.totalInvested) >= 1000000 
                                                                ? ((crisis2008.finalValue - crisis2008.totalInvested) / 1000000).toFixed(1) + 'M' 
                                                                : ((crisis2008.finalValue - crisis2008.totalInvested) / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-emerald-700 font-semibold">
                                                            ✓ Still grew despite crash!
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Dot-com Crash */}
                                            <div className="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-5">
                                                <div className="flex items-center justify-between mb-3">
                                                    <h3 className="font-bold text-gray-800 text-lg">🌐 Dot-com Crash (2000-2002)</h3>
                                                    <span className="text-xs bg-purple-100 px-2 py-1 rounded font-semibold text-purple-700">
                                                        Actual Historical Returns
                                                    </span>
                                                </div>
                                                <p className="text-sm text-gray-700 mb-3">
                                                    3 years of losses (-9%, -12%, -22%), then recovery. Tech bubble burst.
                                                </p>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <div className="text-xs text-gray-600">Final Value</div>
                                                        <div className="text-2xl font-bold text-purple-700">
                                                            ${crisisDotCom.finalValue >= 1000000 
                                                                ? (crisisDotCom.finalValue / 1000000).toFixed(1) + 'M' 
                                                                : (crisisDotCom.finalValue / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-gray-500">
                                                            {((crisisDotCom.finalValue / finalValue - 1) * 100).toFixed(1)}% vs. expected
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">Total Growth</div>
                                                        <div className="text-2xl font-bold text-green-600">
                                                            ${(crisisDotCom.finalValue - crisisDotCom.totalInvested) >= 1000000 
                                                                ? ((crisisDotCom.finalValue - crisisDotCom.totalInvested) / 1000000).toFixed(1) + 'M' 
                                                                : ((crisisDotCom.finalValue - crisisDotCom.totalInvested) / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-emerald-700 font-semibold">
                                                            ✓ Recovered & grew!
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Great Depression */}
                                            <div className="bg-gradient-to-r from-gray-50 to-slate-100 border-2 border-gray-400 rounded-lg p-5">
                                                <div className="flex items-center justify-between mb-3">
                                                    <h3 className="font-bold text-gray-800 text-lg">🌑 Great Depression Style (1929-1933)</h3>
                                                    <span className="text-xs bg-gray-200 px-2 py-1 rounded font-semibold text-gray-700">
                                                        Modeled Historical Pattern
                                                    </span>
                                                </div>
                                                <p className="text-sm text-gray-700 mb-3">
                                                    4 years of catastrophic losses (-80% total), then slow recovery. Worst-case scenario.
                                                </p>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <div className="text-xs text-gray-600">Final Value</div>
                                                        <div className="text-2xl font-bold text-gray-700">
                                                            ${crisisDepression.finalValue >= 1000000 
                                                                ? (crisisDepression.finalValue / 1000000).toFixed(1) + 'M' 
                                                                : (crisisDepression.finalValue / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-gray-500">
                                                            {((crisisDepression.finalValue / finalValue - 1) * 100).toFixed(1)}% vs. expected
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">Total Growth</div>
                                                        <div className="text-2xl font-bold text-orange-600">
                                                            ${(crisisDepression.finalValue - crisisDepression.totalInvested) >= 1000000 
                                                                ? ((crisisDepression.finalValue - crisisDepression.totalInvested) / 1000000).toFixed(1) + 'M' 
                                                                : ((crisisDepression.finalValue - crisisDepression.totalInvested) / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-orange-700 font-semibold">
                                                            {crisisDepression.finalValue > crisisDepression.totalInvested ? '✓ Still grew overall' : '⚠ Minimal growth'}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mt-4">
                                                <p className="text-sm text-blue-800">
                                                    <strong>💡 Key Insight:</strong> Even through the worst market crashes in history, 
                                                    staying invested + regular contributions = recovery. Time in the market beats timing the market.
                                                </p>
                                            </div>
                                        </div>
                                    )}

                                    {/* What-If Scenarios Tab */}
                                    {stressTestTab === 'what-if' && (
                                        <div className="space-y-4">
                                            <p className="text-sm text-gray-600 mb-4">
                                                Test specific portfolio risks mentioned: small-cap wipeout, bond crisis, international collapse. 
                                                See how diversification protects you.
                                            </p>

                                            {/* Small-Cap Wipeout */}
                                            <div className="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-300 rounded-lg p-5">
                                                <h3 className="font-bold text-gray-800 text-lg mb-2">📉 Small-Cap Wipeout (-60%)</h3>
                                                <p className="text-sm text-gray-700 mb-3">
                                                    What if small-cap stocks crash 60%? Your {usAllocation}% US allocation protects you.
                                                </p>
                                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                                    <div>
                                                        <div className="text-xs text-gray-600">Immediate Impact</div>
                                                        <div className="text-xl font-bold text-red-600">
                                                            {whatIfSmallCap.impactPercent.toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-gray-500">Portfolio loss</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">Final Value</div>
                                                        <div className="text-xl font-bold text-amber-700">
                                                            ${whatIfSmallCap.finalValue >= 1000000 
                                                                ? (whatIfSmallCap.finalValue / 1000000).toFixed(1) + 'M' 
                                                                : (whatIfSmallCap.finalValue / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-gray-500">After recovery</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">vs Expected</div>
                                                        <div className="text-xl font-bold text-blue-600">
                                                            {((whatIfSmallCap.finalValue / finalValue - 1) * 100).toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-emerald-700 font-semibold">Diversification helps!</div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Bond Crisis */}
                                            <div className="bg-gradient-to-r from-rose-50 to-red-50 border-2 border-rose-300 rounded-lg p-5">
                                                <h3 className="font-bold text-gray-800 text-lg mb-2">📈 Bond Crisis (Rates Spike +5%)</h3>
                                                <p className="text-sm text-gray-700 mb-3">
                                                    What if interest rates spike and bonds drop 20%? Your {bondAllocation}% bond allocation limits damage.
                                                </p>
                                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                                    <div>
                                                        <div className="text-xs text-gray-600">Immediate Impact</div>
                                                        <div className="text-xl font-bold text-red-600">
                                                            {whatIfBondCrisis.impactPercent.toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-gray-500">Portfolio loss</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">Final Value</div>
                                                        <div className="text-xl font-bold text-rose-700">
                                                            ${whatIfBondCrisis.finalValue >= 1000000 
                                                                ? (whatIfBondCrisis.finalValue / 1000000).toFixed(1) + 'M' 
                                                                : (whatIfBondCrisis.finalValue / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-gray-500">After recovery</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">vs Expected</div>
                                                        <div className="text-xl font-bold text-blue-600">
                                                            {((whatIfBondCrisis.finalValue / finalValue - 1) * 100).toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-gray-500">Minimal impact</div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* International Collapse */}
                                            <div className="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-300 rounded-lg p-5">
                                                <h3 className="font-bold text-gray-800 text-lg mb-2">🌍 International Collapse (VXUS → 0)</h3>
                                                <p className="text-sm text-gray-700 mb-3">
                                                    What if international markets go to zero? Your {internationalAllocation}% allocation is at risk.
                                                </p>
                                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                                    <div>
                                                        <div className="text-xs text-gray-600">Immediate Impact</div>
                                                        <div className="text-xl font-bold text-red-600">
                                                            {whatIfIntlCollapse.impactPercent.toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-gray-500">Portfolio loss</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">Final Value</div>
                                                        <div className="text-xl font-bold text-indigo-700">
                                                            ${whatIfIntlCollapse.finalValue >= 1000000 
                                                                ? (whatIfIntlCollapse.finalValue / 1000000).toFixed(1) + 'M' 
                                                                : (whatIfIntlCollapse.finalValue / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-gray-500">After recovery</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">vs Expected</div>
                                                        <div className="text-xl font-bold text-blue-600">
                                                            {((whatIfIntlCollapse.finalValue / finalValue - 1) * 100).toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-gray-500">US stocks carry you</div>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Armageddon */}
                                            <div className="bg-gradient-to-r from-red-100 to-orange-100 border-4 border-red-500 rounded-lg p-5">
                                                <h3 className="font-bold text-gray-800 text-lg mb-2">💀 Armageddon (All Three At Once)</h3>
                                                <p className="text-sm text-gray-700 mb-3">
                                                    What if everything collapses simultaneously? Small-cap wipeout + bond crisis + international collapse.
                                                </p>
                                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                                    <div>
                                                        <div className="text-xs text-gray-600">Immediate Impact</div>
                                                        <div className="text-2xl font-bold text-red-700">
                                                            {whatIfArmageddon.impactPercent.toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-red-600 font-semibold">Catastrophic loss</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">Final Value</div>
                                                        <div className="text-2xl font-bold text-orange-700">
                                                            ${whatIfArmageddon.finalValue >= 1000000 
                                                                ? (whatIfArmageddon.finalValue / 1000000).toFixed(1) + 'M' 
                                                                : (whatIfArmageddon.finalValue / 1000).toFixed(0) + 'K'}
                                                        </div>
                                                        <div className="text-xs text-gray-500">After recovery</div>
                                                    </div>
                                                    <div>
                                                        <div className="text-xs text-gray-600">vs Expected</div>
                                                        <div className="text-2xl font-bold text-blue-600">
                                                            {((whatIfArmageddon.finalValue / finalValue - 1) * 100).toFixed(1)}%
                                                        </div>
                                                        <div className="text-xs text-orange-700 font-semibold">
                                                            {whatIfArmageddon.finalValue > whatIfArmageddon.totalInvested ? 'Still beats contributions!' : 'Severe impact'}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-green-50 border-2 border-green-300 rounded-lg p-4 mt-4">
                                                <p className="text-sm text-green-800">
                                                    <strong>🛡️ Key Insight:</strong> Even in catastrophic scenarios affecting specific asset classes, 
                                                    diversification limits your downside. No single allocation is exposed to total loss.
                                                </p>
                                            </div>
                                        </div>
                                    )}

                                    {/* vs Cash Tab */}
                                    {stressTestTab === 'vs-cash' && (
                                        <div className="space-y-4">
                                            <p className="text-sm text-gray-600 mb-4">
                                                Compare your portfolio to keeping money in cash or savings accounts. 
                                                Even in a crisis, staying invested beats cash losing to inflation.
                                            </p>

                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                {/* Your Portfolio (Crisis) */}
                                                <div className="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-lg p-5">
                                                    <h3 className="font-bold text-gray-800 mb-3">📊 Your Portfolio (Crisis Scenario)</h3>
                                                    <div className="text-3xl font-bold text-blue-700 mb-2">
                                                        ${(() => {
                                                            const val = growthDataCrisis.values[growthDataCrisis.values.length - 1];
                                                            return val >= 1000000 
                                                                ? (val / 1000000).toFixed(1) + 'M' 
                                                                : (val / 1000).toFixed(0) + 'K';
                                                        })()}
                                                    </div>
                                                    <div className="text-xs text-gray-600 mb-2">
                                                        {scenarios.crisis.toFixed(1)}% annual return
                                                    </div>
                                                    <div className="text-sm text-green-700 font-semibold">
                                                        {((growthDataCrisis.values[growthDataCrisis.values.length - 1] / growthDataCrisis.totalContributions[growthDataCrisis.totalContributions.length - 1]) * 100 - 100).toFixed(0)}% growth
                                                    </div>
                                                    <p className="text-xs text-gray-500 mt-2">
                                                        Even in severe downturn, you grow your money.
                                                    </p>
                                                </div>

                                                {/* Cash */}
                                                <div className="bg-gradient-to-br from-gray-50 to-slate-100 border-2 border-gray-300 rounded-lg p-5">
                                                    <h3 className="font-bold text-gray-800 mb-3">💵 Cash (0% Return)</h3>
                                                    <div className="text-3xl font-bold text-gray-700 mb-2">
                                                        ${(() => {
                                                            const val = cashScenario.values[cashScenario.values.length - 1];
                                                            return val >= 1000000 
                                                                ? (val / 1000000).toFixed(1) + 'M' 
                                                                : (val / 1000).toFixed(0) + 'K';
                                                        })()}
                                                    </div>
                                                    <div className="text-xs text-gray-600 mb-2">
                                                        0% annual return
                                                    </div>
                                                    <div className="text-sm text-gray-600 font-semibold">
                                                        0% growth (just contributions)
                                                    </div>
                                                    <p className="text-xs text-red-600 mt-2 font-semibold">
                                                        Losing ${(() => {
                                                            const val = finalValue - cashScenario.values[cashScenario.values.length - 1];
                                                            return val >= 1000000 
                                                                ? (val / 1000000).toFixed(1) + 'M' 
                                                                : (val / 1000).toFixed(0) + 'K';
                                                        })()} vs. invested portfolio
                                                    </p>
                                                </div>

                                                {/* Inflation Loss */}
                                                <div className="bg-gradient-to-br from-red-50 to-orange-50 border-2 border-red-300 rounded-lg p-5">
                                                    <h3 className="font-bold text-gray-800 mb-3">📉 Losing to Inflation</h3>
                                                    <div className="text-3xl font-bold text-red-700 mb-2">
                                                        ${(() => {
                                                            const val = inflationLoss.values[inflationLoss.values.length - 1];
                                                            return val >= 1000000 
                                                                ? (val / 1000000).toFixed(1) + 'M' 
                                                                : (val / 1000).toFixed(0) + 'K';
                                                        })()}
                                                    </div>
                                                    <div className="text-xs text-gray-600 mb-2">
                                                        -3% real return
                                                    </div>
                                                    <div className="text-sm text-red-700 font-semibold">
                                                        {((inflationLoss.values[inflationLoss.values.length - 1] / inflationLoss.totalContributions[inflationLoss.totalContributions.length - 1]) * 100 - 100).toFixed(0)}% loss
                                                    </div>
                                                    <p className="text-xs text-red-600 mt-2 font-semibold">
                                                        Losing ${(() => {
                                                            const val = finalValue - inflationLoss.values[inflationLoss.values.length - 1];
                                                            return val >= 1000000 
                                                                ? (val / 1000000).toFixed(1) + 'M' 
                                                                : (val / 1000).toFixed(0) + 'K';
                                                        })()} vs. invested portfolio
                                                    </p>
                                                </div>
                                            </div>

                                            <div className="bg-emerald-50 border-2 border-emerald-300 rounded-lg p-5">
                                                <h3 className="font-bold text-gray-800 text-lg mb-3">📈 The Bottom Line</h3>
                                                <div className="space-y-2 text-sm">
                                                    <p className="text-gray-700">
                                                        <strong>Crisis Portfolio vs. Cash:</strong> <span className="text-green-700 font-bold">
                                                            +${(() => {
                                                                const val = growthDataCrisis.values[growthDataCrisis.values.length - 1] - cashScenario.values[cashScenario.values.length - 1];
                                                                return val >= 1000000 
                                                                    ? (val / 1000000).toFixed(1) + 'M' 
                                                                    : (val / 1000).toFixed(0) + 'K';
                                                            })()} better
                                                        </span>
                                                    </p>
                                                    <p className="text-gray-700">
                                                        <strong>Crisis Portfolio vs. Inflation Loss:</strong> <span className="text-green-700 font-bold">
                                                            +${(() => {
                                                                const val = growthDataCrisis.values[growthDataCrisis.values.length - 1] - inflationLoss.values[inflationLoss.values.length - 1];
                                                                return val >= 1000000 
                                                                    ? (val / 1000000).toFixed(1) + 'M' 
                                                                    : (val / 1000).toFixed(0) + 'K';
                                                            })()} better
                                                        </span>
                                                    </p>
                                                    <p className="text-emerald-800 font-semibold mt-3">
                                                        ✅ Even in the worst market crisis, staying invested beats cash or losing to inflation!
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Export Report Section */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">📧 Export Your Report</h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                {/* Download PDF */}
                                <div className="border-2 border-blue-200 rounded-lg p-6 bg-blue-50">
                                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <Download className="w-5 h-5 text-blue-600" />
                                        Download PDF Report
                                    </h3>
                                    <p className="text-sm text-gray-600 mb-4">
                                        Generate a comprehensive PDF with your portfolio allocations, cost analysis, and growth projections.
                                    </p>
                                    <button
                                        onClick={generatePDF}
                                        disabled={isGeneratingPDF}
                                        className="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        <Download className="w-5 h-5" />
                                        {isGeneratingPDF ? 'Generating PDF...' : 'Download PDF Report'}
                                    </button>
                                </div>

                                {/* Email Report */}
                                <div className="border-2 border-green-200 rounded-lg p-6 bg-green-50">
                                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        <Mail className="w-5 h-5 text-green-600" />
                                        Email Report to Yourself
                                    </h3>
                                    <p className="text-sm text-gray-600 mb-4">
                                        Send a detailed text summary to your email. Your email client will open with the report pre-filled.
                                    </p>
                                    <input
                                        type="email"
                                        placeholder="your.email@example.com"
                                        value={userEmail}
                                        onChange={(e) => setUserEmail(e.target.value)}
                                        className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none mb-3 text-sm"
                                    />
                                    <button
                                        onClick={sendEmailReport}
                                        className="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold flex items-center justify-center gap-2"
                                    >
                                        <Mail className="w-5 h-5" />
                                        Open Email Client
                                    </button>
                                </div>
                            </div>

                            <p className="text-xs text-gray-500 mt-4 text-center">
                                💡 Tip: Save these reports for your records or share with your financial advisor
                            </p>
                        </div>

                        {/* Why This Portfolio */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">Why Low-Cost Index Funds?</h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <h3 className="font-semibold text-gray-800 mb-2">✓ Ultra-Low Costs</h3>
                                    <p className="text-sm text-gray-600">
                                        These ETFs have expense ratios of 0.03-0.11%. Over decades, low fees compound into massive savings.
                                    </p>
                                </div>

                                <div className="bg-green-50 p-4 rounded-lg">
                                    <h3 className="font-semibold text-gray-800 mb-2">✓ Tax Efficient</h3>
                                    <p className="text-sm text-gray-600">
                                        ETFs create fewer taxable events than mutual funds. Low turnover means qualified dividend treatment.
                                    </p>
                                </div>

                                <div className="bg-purple-50 p-4 rounded-lg">
                                    <h3 className="font-semibold text-gray-800 mb-2">✓ Instant Diversification</h3>
                                    <p className="text-sm text-gray-600">
                                        2-3 funds give you exposure to thousands of companies globally. Simple, effective, proven.
                                    </p>
                                </div>

                                <div className="bg-orange-50 p-4 rounded-lg">
                                    <h3 className="font-semibold text-gray-800 mb-2">✓ Set & Forget</h3>
                                    <p className="text-sm text-gray-600">
                                        No need to pick stocks or time the market. Index investing beats most active managers long-term.
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* Tax Efficiency & Fees Explained */}
                        <div className="bg-white rounded-2xl shadow-xl p-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">📊 Understanding Fees & Tax Efficiency</h2>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div className="border-2 border-blue-200 rounded-lg p-4 bg-blue-50">
                                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        💵 Expense Ratios
                                    </h3>
                                    <div className="space-y-2 text-sm text-gray-700">
                                        <p><span className="font-semibold">0.03%:</span> Exceptional (Vanguard, Schwab, iShares core funds)</p>
                                        <p><span className="font-semibold">0.04-0.06%:</span> Excellent (Most low-cost index ETFs)</p>
                                        <p><span className="font-semibold">0.07-0.11%:</span> Very good (International/emerging market funds)</p>
                                        <p className="text-xs text-gray-600 mt-2 pt-2 border-t border-blue-300">
                                            Example: On $10,000, a 0.03% fee costs $3/year vs. 1% = $100/year. Over 30 years with growth, that difference becomes ~$25,000!
                                        </p>
                                    </div>
                                </div>

                                <div className="border-2 border-green-200 rounded-lg p-4 bg-green-50">
                                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        🏛️ Tax Efficiency Ratings
                                    </h3>
                                    <div className="space-y-2 text-sm text-gray-700">
                                        <p><span className="font-semibold">Excellent:</span> Low turnover (3-5%), minimal capital gains distributions</p>
                                        <p><span className="font-semibold">Very Good:</span> Moderate turnover (4-15%), occasional distributions</p>
                                        <p><span className="font-semibold">Good:</span> Higher turnover (8-15%), more frequent distributions</p>
                                        <p className="text-xs text-gray-600 mt-2 pt-2 border-t border-green-300">
                                            All these ETFs qualify for: (1) Qualified dividend tax rates (max 20% vs. ordinary income), (2) Long-term capital gains rates if held 1+ year
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="border-2 border-purple-200 rounded-lg p-4 bg-purple-50">
                                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        🔄 Turnover Rate
                                    </h3>
                                    <p className="text-sm text-gray-700 mb-2">
                                        Percentage of holdings replaced annually. Lower is better for taxes.
                                    </p>
                                    <div className="space-y-1 text-sm text-gray-700">
                                        <p><span className="font-semibold">3-5%:</span> Very low (S&P 500, Total Market)</p>
                                        <p><span className="font-semibold">5-10%:</span> Low (International broad market)</p>
                                        <p><span className="font-semibold">10-15%:</span> Moderate (Small-cap, emerging markets)</p>
                                    </div>
                                </div>

                                <div className="border-2 border-teal-200 rounded-lg p-4 bg-teal-50">
                                    <h3 className="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                                        💰 Dividend Yields
                                    </h3>
                                    <p className="text-sm text-gray-700 mb-2">
                                        Annual dividend income as % of investment. Paid quarterly.
                                    </p>
                                    <div className="space-y-1 text-sm text-gray-700">
                                        <p><span className="font-semibold">1.3-1.5%:</span> US stocks (growth-focused)</p>
                                        <p><span className="font-semibold">3.0-3.3%:</span> International developed (value-focused)</p>
                                        <p><span className="font-semibold">3.4-3.7%:</span> Emerging markets (higher yield)</p>
                                    </div>
                                </div>
                            </div>

                            <div className="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div className="flex items-start gap-2">
                                    <Info className="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0" />
                                    <div className="text-sm text-gray-700">
                                        <span className="font-semibold">Tax Tip:</span> In taxable accounts, these low-turnover ETFs minimize taxable events. 
                                        You only pay capital gains tax when YOU sell (not when the fund rebalances). Dividends are taxed annually but qualify for lower rates. 
                                        For tax-advantaged accounts (IRA, 401k), tax efficiency matters less since growth is tax-deferred.
                                    </div>
                                </div>
                            </div>

                            <div className="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div className="flex items-start gap-2">
                                    <Info className="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0" />
                                    <div className="text-sm text-gray-700">
                                        <span className="font-semibold">Disclaimer:</span> This calculator is for educational purposes only. 
                                        Projections are based on assumptions and past performance doesn't guarantee future results. 
                                        Tax treatment depends on your individual situation. Consider consulting a financial advisor and tax professional for personalized advice.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InvestmentCalculator />);
    </script>
</body>
</html>